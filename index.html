<!DOCTYPE html><html><head><meta charset="utf-8"><title>Estralle Tommm&#39;s Warehouse</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="上善若水，自强不息"><meta name="keywords" content="博客,blog,EstralleTommm"><meta property="og:type" content="website"><meta property="og:title" content="Estralle Tommm&#39;s Warehouse"><meta property="og:url" content="https:&#x2F;&#x2F;blog.estralletommm.top&#x2F;"><meta property="og:site_name" content="Estralle Tommm&#39;s Warehouse"><meta property="og:description" content="上善若水，自强不息"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary"><link rel="alternate" href="/atom.xml" title="Estralle Tommm&#39;s Warehouse" type="application/atom+xml"><link rel="icon" href="/favicon.png"><link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css"><link rel="stylesheet" href="/css/style.css"></head><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"> <a href="/" id="logo">Estralle Tommm&#39;s Warehouse</a></h1></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a></nav><nav id="sub-nav"><a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a><a id="nav-search-btn" class="nav-icon" title="搜索"></a></nav><div id="search-form-wrap"><form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.estralletommm.top"></form></div></div></div></header><div class="outer"><section id="main"><article id="post-单点登录三——CAS Clietn源码解析" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"> <a href="/2021/11/04/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%B8%89%E2%80%94%E2%80%94CAS%20Clietn%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="article-date"><time datetime="2021-11-04T00:56:04.000Z" itemprop="datePublished">2021-11-04</time></a><div class="article-category"> <a class="article-category-link" href="/categories/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/">单点登录</a></div></div><div class="article-inner"><header class="article-header"><h1 itemprop="name"> <a class="article-title" href="/2021/11/04/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%B8%89%E2%80%94%E2%80%94CAS%20Clietn%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">单点登录三——CAS Client源码分析</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="CAS客户端源码解析"><a href="#CAS客户端源码解析" class="headerlink" title="CAS客户端源码解析"></a><center>CAS客户端源码解析</center></h1><h2 id="介绍："><a href="#介绍：" class="headerlink" title="介绍："></a>介绍：</h2><p>​ CAS客户端源码虽说不是很多，但每一个都介绍的话就显得多余了。所以虽说本节是分析客户端源码，实则只是通过正常CAS流程（CAS v1提供的基础单点功能，代理模式是v2的功能，SMAL是 v3的功能）用到的Filter为切入点，做一点引导性的工作。本节基于<code>cas-client-core-3.2.1.jar</code>版本分析。</p><h2 id="源码分析："><a href="#源码分析：" class="headerlink" title="源码分析："></a>源码分析：</h2><p>​ 我们系统集成CASClient一般会在web.xml中配置如下几个过滤器：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 用于单点退出，该监听器和过滤器用于实现单点登出功能，可选配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.jasig.cas.client.session.SingleSignOutHttpSessionListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Single Sign Out Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.session.SingleSignOutFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Single Sign Out Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/SSOLogout<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 该过滤器负责用户的认证工作 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CASFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.authentication.AuthenticationFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>casServerLoginUrl<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--这里的server是CAS服务端的登录地址,login为固定值--&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>https://host:port/cas/login<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>serverName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>https://host:port<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CASFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/SSOLogin<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 该过滤器负责对Ticket的校验工作，必须启用它 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Validation Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.validation.Cas20ProxyReceivingTicketValidationFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>casServerUrlPrefix<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--这里的server是CAS服务端的地址,这里不要加login--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>https://host:port/cas<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>serverName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>https://host:port<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encodeServiceUrl<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--去身份认证的校验的时候也需要加一个编码--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Validation Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/SSOLogin<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 该过滤器负责实现HttpServletRequest请求的包裹，比如允许开发者通过HttpServletRequest的getRemoteUser()方法获得SSO登录用户的登录名。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS HttpServletRequest Wrapper Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.util.HttpServletRequestWrapperFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS HttpServletRequest Wrapper Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/SSOLogin<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><p>那么每一个过滤器或者监听器是干什么的呢？结合上一节的CAS流程我们一起看一下。</p><h3 id="1、AuthenticationFilter"><a href="#1、AuthenticationFilter" class="headerlink" title="1、AuthenticationFilter"></a>1、AuthenticationFilter</h3><blockquote><p>每个人都不是独立存在社会中，身上少不了你爸的财产，你妈的美貌。—— 刚编的</p></blockquote><p>Java类也是一样，我们先看看AuthenticationFilter的继承关系：</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211103175837009.png" alt="image-20211103175837009"></p><p>继承关系并不复杂四代单传，来看看都是干啥的</p><ul><li><strong>Filter：</strong>这个大家都认识，过滤器接口；</li><li><strong>AbstractConfigurationFilter：</strong>Abstract类，主要功能是获取配置文件值；</li><li><p><strong>AbstractCasFilter ：</strong> Abstract类， 存放所有CAS过滤器的公共代码；</p></li><li><p><strong>AuthenticationFilter：</strong>实现类，主要负责用户的认证工作。</p></li></ul><p>对应上一张继承关系的图，各个类的功能可以参考下图：</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211103180948570.png" alt="image-20211103180948570"></p><p>​ 结合CAS流程，分析代码。AuthenticationFilter在服务启动时，会创建对应过滤器实例，并调用init方法完成初始化操作，并且创建实例和init方法只执行一次。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 父类init方法会获取配置值并赋值给变量，同时会调用initInternal方法</span></span><br><span class="line">    <span class="keyword">super</span>.init();</span><br><span class="line">    CommonUtils.assertNotNull(<span class="keyword">this</span>.casServerLoginUrl, <span class="string">"casServerLoginUrl cannot be null."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取配置值，赋给变量</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">(<span class="keyword">final</span> FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isIgnoreInitConfiguration()) &#123;</span><br><span class="line">        <span class="keyword">super</span>.initInternal(filterConfig);</span><br><span class="line">        setCasServerLoginUrl(getPropertyFromInitParams(filterConfig, <span class="string">"casServerLoginUrl"</span>, <span class="keyword">null</span>));</span><br><span class="line">        log.trace(<span class="string">"Loaded CasServerLoginUrl parameter: "</span> + <span class="keyword">this</span>.casServerLoginUrl);</span><br><span class="line">        setRenew(parseBoolean(getPropertyFromInitParams(filterConfig, <span class="string">"renew"</span>, <span class="string">"false"</span>)));</span><br><span class="line">        log.trace(<span class="string">"Loaded renew parameter: "</span> + <span class="keyword">this</span>.renew);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​ 这里可以发现，需要从配置中获取的值，就是我们能配置的值（当没有配置时会有默认值）。比如前面xml文件中</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>casServerLoginUrl<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--这里的server是CAS服务端的登录地址,login为固定值--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>https://url:port/cas/login<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure><p>​ 就是在过滤器初始化时将<code>https://url:port/cas/login</code>赋值给<code>casServerLoginUrl</code>；</p><p>​ 当请求被AuthenticationFilter过滤到时执行doFilter方法，具体的验证过程和逻辑也就在这个方法里:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(<span class="keyword">final</span> ServletRequest servletRequest, <span class="keyword">final</span> ServletResponse servletResponse, <span class="keyword">final</span> FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line">    <span class="keyword">final</span> HttpServletResponse response = (HttpServletResponse) servletResponse;</span><br><span class="line">    <span class="keyword">final</span> HttpSession session = request.getSession(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// 从session中取出Assertion对象；后面会分析到Assertion在何时创建；</span></span><br><span class="line">    <span class="keyword">final</span> Assertion assertion = session != <span class="keyword">null</span> ? (Assertion) session.getAttribute(CONST_CAS_ASSERTION) : <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 如果session中有Assertion对象，表示已经登录过了，放行；</span></span><br><span class="line">    <span class="keyword">if</span> (assertion != <span class="keyword">null</span>) &#123;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 拼接当前请求</span></span><br><span class="line">    <span class="keyword">final</span> String serviceUrl = constructServiceUrl(request, response);</span><br><span class="line">    <span class="comment">// 从request中获取ticket</span></span><br><span class="line">    <span class="keyword">final</span> String ticket = CommonUtils.safeGetParameter(request,getArtifactParameterName());</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> wasGatewayed = <span class="keyword">this</span>.gatewayStorage.hasGatewayedAlready(request, serviceUrl);</span><br><span class="line">	<span class="comment">// 如果ticket存在，放行到下一个过滤器验证；</span></span><br><span class="line">    <span class="keyword">if</span> (CommonUtils.isNotBlank(ticket) || wasGatewayed) &#123;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String modifiedServiceUrl;</span><br><span class="line"></span><br><span class="line">    log.debug(<span class="string">"no ticket and no assertion found"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.gateway) &#123;</span><br><span class="line">        log.debug(<span class="string">"setting gateway attribute in session"</span>);</span><br><span class="line">        modifiedServiceUrl = <span class="keyword">this</span>.gatewayStorage.storeGatewayInformation(request, serviceUrl);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        modifiedServiceUrl = serviceUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"Constructed service url: "</span> + modifiedServiceUrl);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 拼接认证中心登录url</span></span><br><span class="line">    <span class="keyword">final</span> String urlToRedirectTo = CommonUtils.constructRedirectUrl(<span class="keyword">this</span>.casServerLoginUrl, getServiceParameterName(), modifiedServiceUrl, <span class="keyword">this</span>.renew, <span class="keyword">this</span>.gateway);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">"redirecting to \""</span> + urlToRedirectTo + <span class="string">"\""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 重定向</span></span><br><span class="line">    response.sendRedirect(urlToRedirectTo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大致流程可以总结一下：</p><ol><li><p>从session中获取名为“<em>const_cas_assertion</em>”的assertion对象，判断assertion是否存在，如果存在，说明已经登录，执行下一个过滤器。如果不存在，执行第2步。</p></li><li><p>生成serviceUrl，从request中获取票据参数ticket，判断ticket是否为空，如果不为空执行下一个过滤器。如果为空，执行第3步。</p></li><li><p>生成重定向URL。</p></li><li><p>跳转到单点登录服务器，显示登录页面，此时第一个过滤器执行完成。</p></li></ol><p>所以 AuthenticationFilter 就是判断是否已经登录（走完一遍CAS流程）？是否有ticket票据（CAS验证通过，但还没验证ticket）？如果都没有就重定向到CAS登录url。判断先后顺序也是<strong>先大后小</strong>。</p><h3 id="2、Cas20ProxyReceivingTicketValidationFilter"><a href="#2、Cas20ProxyReceivingTicketValidationFilter" class="headerlink" title="2、Cas20ProxyReceivingTicketValidationFilter"></a>2、Cas20ProxyReceivingTicketValidationFilter</h3><p>同样我们看一下继承关系</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104123636371.png" alt="image-20211104123636371"></p><p>​ 前三个在刚刚分析AuthenticationFilter的时候已经提及了，如果还不清楚可以回看。</p><ul><li><strong>AbstractTicketValidationFilter：</strong>Abstract类，负责ticket的校验；</li><li><strong>Cas20ProxyReceivingTicketValidationFilter：</strong>实现类，根据是否使用设置了代理参数，初始化TicketValidator（票据校验器）；</li></ul><p>我们可以发现，最有用的验证票据部分被放在了Abstract类中，说明所有继承AbstractTicketValidationFilter的类都是具有校验ticket能力的。AbstractTicketValidationFilter的子类如下：</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104124757651.png" alt="image-20211104124757651"></p><p>​ 结合CAS v1、v2、v3不同版本，对应产生了三个子类，但基础工作都是验证ticket由父类实现。</p><p>​ 单从实现CAS基本流程验证ticket来说，配置三个任意一个过滤器都可以实现，但我在上面的web.xml中配置的是v2版本的Cas20ProxyReceivingTicketValidationFilter，原因是代理模式在在实际生产中用到的很多，而v1的Cas10TicketValidationFilter不支持代理模式，v3的Saml11AuthenticationFilter是引入了SAML。</p><p>​ 这三个实现类的内容都是初始化参数和重写getTicketValidator()方法，得到ticket校验器，这样就能用各自的方式校验。</p><p>​ AbstractTicketValidationFilter中除了基本的字段维护和初始化方法外，我们重点看一下ticket校验的逻辑代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(<span class="keyword">final</span> ServletRequest servletRequest, <span class="keyword">final</span> ServletResponse servletResponse, <span class="keyword">final</span> FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">	<span class="comment">// preFilter被CAS20子类重写，用来执行ticket验证代码之前处理ProxyReceptor请求；</span></span><br><span class="line">    <span class="keyword">if</span> (!preFilter(servletRequest, servletResponse, filterChain)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line">    <span class="keyword">final</span> HttpServletResponse response = (HttpServletResponse) servletResponse;</span><br><span class="line">    <span class="comment">// 从request中获取ticket；</span></span><br><span class="line">    <span class="keyword">final</span> String ticket = CommonUtils.safeGetParameter(request, getArtifactParameterName());</span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	 * ticket不为空，则执行验证过程；ticket为空直接放行；</span></span><br><span class="line"><span class="comment">     * 此时ticket为空由两种情况：</span></span><br><span class="line"><span class="comment">     * 	1. 还从未到CASService登录认证（因为登录认证后会携带ticket）；</span></span><br><span class="line"><span class="comment">     *	2. 已经完成过一次成功登录（登录完成后TGC有效期内不会再到CASService认证，所以不会有ticket）；</span></span><br><span class="line"><span class="comment">     * 所以从这里分析来看，认证用的filter 和 验证ticket的filter 过滤器配置以及执行顺序颠倒，流程也是严密的，不会有错误。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (CommonUtils.isNotBlank(ticket)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">"Attempting to validate ticket: "</span> + ticket);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 验证ticket并返回Assertion对象，验证失败会抛出TicketValidationException；</span></span><br><span class="line">            <span class="keyword">final</span> Assertion assertion = <span class="keyword">this</span>.ticketValidator.validate(ticket, constructServiceUrl(request, response));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"Successfully authenticated user: "</span> + assertion.getPrincipal().getName());</span><br><span class="line">            &#125;</span><br><span class="line">			<span class="comment">// 将assertion存入request；</span></span><br><span class="line">            request.setAttribute(CONST_CAS_ASSERTION, assertion);</span><br><span class="line">			<span class="comment">// 判断是否使用session（useSession字段可以配置，默认true）</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.useSession) &#123;</span><br><span class="line">                <span class="comment">// 将assertion存入session中，与前面AuthenticationFilter从session中取assertion对应；</span></span><br><span class="line">                request.getSession().setAttribute(CONST_CAS_ASSERTION, assertion);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 调用成功方法，此方法为空方法并且没有被重写，应该是留给开发者重写，进行验证成功后的个性化操作；</span></span><br><span class="line">            onSuccessfulValidation(request, response, assertion);</span><br><span class="line">			<span class="comment">// 验证成功后是否重定向，redirectAfterValidation可以配置，默认false；</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.redirectAfterValidation) &#123;</span><br><span class="line">                log. debug(<span class="string">"Redirecting after successful ticket validation."</span>);</span><br><span class="line">                <span class="comment">// 拼接url重定向；</span></span><br><span class="line">                response.sendRedirect(constructServiceUrl(request, response));</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> TicketValidationException e) &#123;</span><br><span class="line">            <span class="comment">// 返回失败状态</span></span><br><span class="line">            response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span><br><span class="line">            log.warn(e, e);</span><br><span class="line">			<span class="comment">// 调用验证失败方法，与成功方法相同；</span></span><br><span class="line">            onFailedValidation(request, response);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.exceptionOnValidationFailure) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 放行，执行下一个过滤器；</span></span><br><span class="line">    filterChain.doFilter(request, response);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​ 当执行完第一个过滤器（AuthenticationFilter）后，跳转到CAS服务器端的登录页面，输入用户名和密码，验证通过后。CAS服务器端会生成TGT，将TGC以cookie返回给浏览器，并将ticket作为重新跳转到应用系统的参数（<a href="https://host:port/SSOLogin?ticket=ST-1-4hH2s5tzsMGCcToDvGCb-cas01.example.org）。此时又进入第一个过滤器AuthenticationFilter，由于存在ticket参数，进入到第二个过滤器TicketValidationFilter，执行doFilter：" target="_blank" rel="noopener">https://host:port/SSOLogin?ticket=ST-1-4hH2s5tzsMGCcToDvGCb-cas01.example.org）。此时又进入第一个过滤器AuthenticationFilter，由于存在ticket参数，进入到第二个过滤器TicketValidationFilter，执行doFilter：</a></p><ol><li>从request获取ticket参数，如果ticket为空，继续处理下一个过滤器。如果参数不为空，验证ticket参数的合法性。</li><li>验证ticket，TicketValidationFilter的validate方法通过httpClient访问CAS服务器端（<a href="https://host:port/cas/serviceValidate?ticket=ST-1-4hH2s5tzsMGCcToDvGCb-cas01.example.org&amp;service=http://host:port/SSOLogin）验证ticket是否正确，并返回assertion对象。如果验证失败，抛出异常，跳转到错误页面。如果验证成功，session会以&quot;_const_cas_assertion_&quot;的名称保存assertion对象，继续处理下一个过滤器。" target="_blank" rel="noopener">https://host:port/cas/serviceValidate?ticket=ST-1-4hH2s5tzsMGCcToDvGCb-cas01.example.org&amp;service=http://host:port/SSOLogin）验证ticket是否正确，并返回assertion对象。如果验证失败，抛出异常，跳转到错误页面。如果验证成功，session会以&quot;_const_cas_assertion_&quot;的名称保存assertion对象，继续处理下一个过滤器。</a></li></ol><h3 id="3、HttpServletRequestWrapperFilter"><a href="#3、HttpServletRequestWrapperFilter" class="headerlink" title="3、HttpServletRequestWrapperFilter"></a>3、HttpServletRequestWrapperFilter</h3><p>​ 这个类与整个单点流程逻辑无关，存在于CAS源码util包下，它的主要功能是对request进行覆盖，使request可以通过一些方法（具体方法之后会讲到）提供认证成功后返回的Assertion的数据（由CAS返回的用户、权限信息都在Assertion对象中，并存在request和session中）。</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104153923648.png" alt="image-20211104153923648"></p><p>​ 我们先来看一下这个类是怎么实现包裹request的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(<span class="keyword">final</span> ServletRequest servletRequest, <span class="keyword">final</span> ServletResponse servletResponse, <span class="keyword">final</span> FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    <span class="comment">// 通过retrievePrincipalFromSessionOrRequest方法从servletRequest中取出用户信息principal；</span></span><br><span class="line">    <span class="keyword">final</span> AttributePrincipal principal = retrievePrincipalFromSessionOrRequest(servletRequest);</span><br><span class="line">	<span class="comment">// 创建CasHttpServletRequestWrapper对象，并放行执行下一个过滤器；</span></span><br><span class="line">    filterChain.doFilter(<span class="keyword">new</span> CasHttpServletRequestWrapper((HttpServletRequest) servletRequest, principal), servletResponse);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取出用户信息；</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AttributePrincipal <span class="title">retrievePrincipalFromSessionOrRequest</span><span class="params">(<span class="keyword">final</span> ServletRequest servletRequest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line">    <span class="keyword">final</span> HttpSession session = request.getSession(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// session为空，就从request中取。否则就从session中取出assertion；</span></span><br><span class="line">    <span class="keyword">final</span> Assertion assertion = (Assertion) (session == <span class="keyword">null</span> ? request.getAttribute(AbstractCasFilter.CONST_CAS_ASSERTION) : session.getAttribute(AbstractCasFilter.CONST_CAS_ASSERTION));</span><br><span class="line">	<span class="comment">// 返回assertion中的用户信息；</span></span><br><span class="line">    <span class="keyword">return</span> assertion == <span class="keyword">null</span> ? <span class="keyword">null</span> : assertion.getPrincipal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​ 代码不难，问题是过滤向下传递的CasHttpServletRequestWrapper是什么？细心一点就可以从上面包的截图看出HttpServletRequestWrapperFilter有一个内部类，这个内部类就是向下一个过滤器传递的CasHttpServletRequestWrapper对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CasHttpServletRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 用户数据对象principal；</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AttributePrincipal principal;</span><br><span class="line">	<span class="comment">// 构造方法，给principal赋值；</span></span><br><span class="line">    CasHttpServletRequestWrapper(<span class="keyword">final</span> HttpServletRequest request, <span class="keyword">final</span> AttributePrincipal principal) &#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        <span class="keyword">this</span>.principal = principal;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 返回用户数据principal；</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Principal <span class="title">getUserPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.principal;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 获取用户数据中name字段（用户标识）；</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRemoteUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> principal != <span class="keyword">null</span> ? <span class="keyword">this</span>.principal.getName() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 判断用户是否有role权限</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUserInRole</span><span class="params">(<span class="keyword">final</span> String role)</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">rolesEqual</span><span class="params">(<span class="keyword">final</span> String given, <span class="keyword">final</span> Object candidate)</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​ 这里就明了了，通过构造CasHttpServletRequestWrapper包装，可以让request通过getUserPrincipal方法获取用户信息，通过getRemoteUser获取用户name字段，通过isUserInRole判断用户是否有权限。</p><p>​ 当然这个类是辅助我们开发的，这样我们就可以通过request直接获取用户信息。当然也可以不用这个类，自己在request或者session中得到Assertion对象，通过操作Assertion对象来获取用户信息。</p><h3 id="4、SingleSignOutFilter"><a href="#4、SingleSignOutFilter" class="headerlink" title="4、SingleSignOutFilter"></a>4、SingleSignOutFilter</h3><p>​ 这个就是单点登出的过滤器了，逻辑也很简单</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(<span class="keyword">final</span> ServletRequest servletRequest, <span class="keyword">final</span> ServletResponse servletResponse, <span class="keyword">final</span> FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (handler.isTokenRequest(request)) &#123;</span><br><span class="line">        <span class="comment">// 如果是带ticket的请求，存储ticket-session的映射关系；</span></span><br><span class="line">        handler.recordSession(request);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (handler.isLogoutRequest(request)) &#123;</span><br><span class="line">        <span class="comment">// 如果是带登出参数的请求，就移除ticket-session映射关系，并将session摧毁；</span></span><br><span class="line">        handler.destroySession(request);</span><br><span class="line">        <span class="comment">// Do not continue up filter chain</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.trace(<span class="string">"Ignoring URI "</span> + request.getRequestURI());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5、SingleSignOutHttpSessionListener</p><p>​ 单点相关的监听器就更没什么内容了，就只干一件事：监听session的destroyed操作，出发该事件的session从ticket-session映射中移除。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sessionDestroyed</span><span class="params">(<span class="keyword">final</span> HttpSessionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sessionMappingStorage == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sessionMappingStorage = getSessionMappingStorage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> HttpSession session = event.getSession();</span><br><span class="line">    sessionMappingStorage.removeBySessionById(session.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="验证："><a href="#验证：" class="headerlink" title="验证："></a>验证：</h2><p>准备：</p><ul><li>本地搭建CAS Service；</li><li>和集成CAS Client的系统A，过滤器配置参考上文web.xml；</li></ul><p>通过浏览器调试，查看请求情况和执行顺序。</p><p>1.访问A的登录地址<code>/h5/h5FunctionList/SSO2H5</code>，此时请求被AuthenticationFilter拦截，判断Assertion为空-&gt;ticket为空-&gt;重定向到CAS Service 的登录页面。</p><p>系统A的登录请求：</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104170331083.png" alt="image-20211104170331083"></p><p>重定向到CAS Service登录地址：</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104170403699.png" alt="image-20211104170403699"></p><p>此时浏览器还没有得到系统A的请求响应，是CAS Service返回的，我们可以观察到多了一条cookie，存的是JSESSIONID，这条是浏览器与CAS Service建立的会话。</p><p>浏览器cookie：</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104170752147.png" alt="image-20211104170752147"></p><p>2.输入正确的用户名和密码，CAS Service验证是正确后，创建TGT并存储，生成TGC，并以cookie的形式返回给浏览器，生成ticket，以参数形式加在url后面，重定向到第一次请求系统A登录的请求。此时浏览器会获得第二个cookie为CASTGC。</p><p>提交用户名密码给CAS Service：</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104172127396.png" alt="image-20211104172127396"></p><p>浏览器名为CASTGC的cookie：</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104172708839.png" alt="image-20211104172708839"></p><p>3.系统A的AuthenticationFilter再次过滤到请求：Assertion为空-&gt;ticket不为空-&gt;放行；被第二个拦截器Cas10TicketValidationFilter过滤到请求：ticket不为空-&gt;验证ticket成功-&gt;放行；</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104173138324.png" alt="image-20211104173138324"></p><p>此次请求成功后，浏览器才第一次接收到系统A的响应并记录下JSESSIONID；</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104173915227.png" alt="image-20211104173915227"></p><p>两个JSESSIONID一个是与CAS Service建立的会话，另一个是与系统A建立的会话。</p><p>此时CAS流程已经完成，其他就是一些HttpServletRequestWrapperFilter封装操作，和正常的登录操作。</p><p>4.当再次请求<code>/h5/h5FunctionList/SSO2H5</code>时，会被AuthenticationFilter拦截掉：Assertion不为空（第一次登录ticket验证成功后，assertion被创建并存入request和session）-&gt;放行；</p><p> 被Cas20ProxyReceivingTicketValidationFilter拦截掉：ticket为空（因为没有去CAS Service验证，所以不会有ticket）-&gt;放行；</p><p> CAS流程完成，进行正常登录操作；</p><p>5.登出流程很简单，就不做过多讲解了，有兴趣的朋友可以自己验证。</p><h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>​ 先来看一下这一节涉及到的所有类的结构，让大家能又一个清晰认识：</p><p><img src="https://wisdomclass.tech/image/blog/20211104image-20211104181033552.png" alt="image-20211104181033552"></p><p>​ 其中最重要的两个filter已经用红框标注出，注意加深理解。</p><p>​ 几千字的文章就写了一天的时间，很多具体的细节到现在也不清晰。就当是一次学习练习吧，顺便希望对想了解CAS的人有点帮助。</p><p>​ 下一节就是对应目前工作的项目，具体集成CAS Client的操作手册，希望能对团队和新人有所帮助，让团队开发向着规范、高效、自动化的方向发展。</p></div><footer class="article-footer"> <a data-url="https://blog.estralletommm.top/2021/11/04/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%B8%89%E2%80%94%E2%80%94CAS%20Clietn%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" data-id="cle6sor470021dw9jha4a1yp1" class="article-share-link">Share</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" rel="tag">单点登录</a></li></ul></footer></div></article><article id="post-单点登录二——CAS" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"> <a href="/2021/10/27/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%BA%8C%E2%80%94%E2%80%94CAS/" class="article-date"><time datetime="2021-10-27T00:56:04.000Z" itemprop="datePublished">2021-10-27</time></a><div class="article-category"> <a class="article-category-link" href="/categories/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/">单点登录</a></div></div><div class="article-inner"><header class="article-header"><h1 itemprop="name"> <a class="article-title" href="/2021/10/27/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%BA%8C%E2%80%94%E2%80%94CAS/">单点登录二——CAS</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="单点登录二——CAS"><a href="#单点登录二——CAS" class="headerlink" title="单点登录二——CAS"></a><center>单点登录二——CAS</center></h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>​ 其实就SSO来说，是一个非常大的主题了，目前各种SSO实现也是特别多的。公司日常遇到的SSO需求也只是逻辑层面的从一个融合系统跳到各种平台，实际内部实现逻辑和步骤，并不一定是严格按照SSO流程走的（更多是在系统原本登录接口上再开放一个后门登录接口，通过奇葩的解密或者验证方式得到用户id，直接登录）。不仅破坏了SSO 的<code>系统不提供登录入口，只接受认证中心的间接授权</code> 原则，其安全性也很值得讨论。</p><p>​ 除了第三方自定义的单点方式，目前接触到最多的也就是CAS流程。就观察朋友同事来看，大多也只再应用层面，对内部细节和流程不是很熟悉，导致排错困难。找个摸鱼时间总结一下。</p><p>​ ps：CAS这个缩写在很多领域都有重名，如Java Unsafe类中的CAS多指 CompareAndSwap方法，本文所有CAS均指代Central Authentication Service中央认证服务。</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>​ CAS 是 Yale 大学发起的一个开源项目，据统计，大概每10个采用开源构建Web SSO的Java项目，就有 8 个使用 CAS 。对这些统计，也不需要太相信，但有一点可以肯定的是，CAS 是一种简单实效，而且足够安全的 SSO 选择。</p><h3 id="一、CAS的体系结构"><a href="#一、CAS的体系结构" class="headerlink" title="一、CAS的体系结构"></a>一、CAS的体系结构</h3><p>​ 从体系结构来看，同SSO的结构CAS包含两部分：</p><ul><li><p>CAS Service</p><p> ​ CAS Server 需要独立部署， 负责完成对用户的认证，TGT、TGC、ST的生成和传递，ST、TGC的验证工作；</p></li><li><p>CAS Client</p><p> ​ CAS Client 负责部署在客户端（注意，是指 Web 应用），原则上， CAS Client 的部署意味着，当有对本地 Web 应用的受保护资源的访问请求，并且需要对请求方进行身份认证， Web 应用不再接受任何的用户名密码等类似的 Credentials ，而是重定向到 CAS Server 进行认证（很多应用还是会保留原本登录接口，这是不符合规范的）。</p></li></ul><h3 id="二、CAS协议"><a href="#二、CAS协议" class="headerlink" title="二、CAS协议"></a>二、CAS协议</h3><p>​ 剖析协议就像剖析设计模式，有些时候，协议繁琐让人摸不着头脑。 CAS 的代理模式要相对复杂一些，它引入了一些新的概念，在这里简单描述一下其原理，有助于大家在配置和调试 CAS SSO 有更清晰的思路。</p><h4 id="1-术语"><a href="#1-术语" class="headerlink" title="1. 术语"></a>1. 术语</h4><p>​ 首先有几个概念需要留下印象：</p><ul><li><p><strong>TGT（Ticket Granting Ticket）</strong>CAS Service验证用户登录通过之后会生成TGC：TGT（key：value）的键值对。TGT是CAS为用户签发的登录凭证（凭证存在说明用户在CAS Service已经登录），而TGC会通过cookie返回给用户，代表用户的<strong>SSO会话</strong>（注意理解全局会话和局部会话的概念，SSO会话为全局会话）。</p></li><li><p><strong>TGC （ Ticket Granting Cookie ）</strong>CAS 会将生成的 TGT 放在 session 中，而 TGC 就是这个 session 的唯一标识(sessionId)，可以认为是 TGT 的key， TGT 就是 TGC 的 value，TGC 以 cookie 的形式保存在浏览器中，每个请求都会尝试携带 TGC。</p></li><li><p><strong>ST（ Service Ticket ）</strong> ST 是CAS Service提供给用户的ticket， 作为参数在GET方法的URL中，通过ticket可以进行身份和权限的验证，获取信息。ST单次有效且由时效性；</p></li><li><p><strong>PGT（Proxy Granting Ticket）</strong>Proxy Service的代理凭据。用户通过CAS成功登录某一Proxy Service后，CAS生成一个PGT对象，缓存在CAS本地，同时将PGT的值（一个UUID字符串）回传给Proxy Service，并保存在Proxy Service里。Proxy Service拿到PGT后，就可以为Target Service（back-end service）做代理，为其申请PT。</p></li><li><p><strong>PGTIOCU（Proxy Granting Ticket I Owe You）</strong>PGTIOU是CAS协议中定义的一种附加票据，它增强了传输、获取PGT的安全性。PGT的传输与获取的过程：Proxy Service调用CAS的serviceValidate接口验证ST成功后，CAS首先会访问pgtUrl指向的Https URL，将生成的 PGT及PGTIOU传输给proxy service，proxy service会以PGTIOU为key，PGT为value，将其存储在Map中；然后CAS会生成验证ST成功的XML消息，返回给Proxy Service，XML消息中含有PGTIOU，proxy service收到XML消息后，会从中解析出PGTIOU的值，然后以其为key，在Map中找出PGT的值，赋值给代表用户信息的Assertion对象的pgtId，同时在Map中将其删除。</p></li><li><p><strong>PT（Proxy Ticket)</strong>PT是用户访问Target Service（back-end service）的票据。如果用户访问的是一个Web应用，则Web应用会要求浏览器提供ST，浏览器就会用Cookie去CAS获取一个ST，然后就可以访问这个Web应用了。如果用户访问的不是一个Web应用，而是一个C/S结构的应用，因为C/S结构的应用得不到Cookie，所以用户不能自己去CAS获取ST，而是通过访问proxy service的接口，凭借proxy service的PGT去获取一个PT，然后才能访问到此应用。</p></li></ul><h4 id="2-TGT、ST、PGT、PT之间关系"><a href="#2-TGT、ST、PGT、PT之间关系" class="headerlink" title="2.  TGT、ST、PGT、PT之间关系"></a>2. TGT、ST、PGT、PT之间关系</h4><ul><li><p>ST是TGT签发的。用户在CAS上认证成功后，CAS生成TGT，用TGT签发一个ST，ST的ticketGrantingTicket属性值是TGT对象，然后把ST的值redirect到客户应用。</p></li><li><p>PGT是ST签发的。用户凭借ST去访问Proxy service，Proxy service去CAS验证ST（同时传递PgtUrl参数给CAS），如果ST验证成功，则CAS用ST签发一个PGT，PGT对象里的ticketGrantingTicket是签发ST的TGT对象。</p></li><li><p>PT是PGT签发的。Proxy service代理back-end service去CAS获取PT的时候，CAS根据传来的pgt参数，获取到PGT对象，然后调用其grantServiceTicket方法，生成一个PT对象。</p><p>看完应该头大了，由个印象就行，根据后面的流程就能很好理解了。</p></li></ul><h4 id="3-CAS基本协议模式"><a href="#3-CAS基本协议模式" class="headerlink" title="3. CAS基本协议模式"></a>3. CAS基本协议模式</h4><p>​ <img src="https://wisdomclass.tech/image/blog/20211027/cas_protocol-1.jpg" alt="cas_protocol-1.jpg"></p><p>​ 上图是一个最基础的 CAS 协议， CAS Client 以 Filter 方式保护 Web 应用的受保护资源，过滤从客户端过来的每一个 Web 请求，同时， CAS Client 会分析 HTTP 请求中是否包请求 Service Ticket( 上图中的 Ticket) ，如果没有，则说明该用户是没有经过认证的，于是， CAS Client 会重定向用户请求到 CAS Server （ Step 2 ）。 Step 3 是用户认证过程，如果用户提供了正确的 Credentials ， CAS Server 会产生一个随机的 Service Ticket ，然后，缓存该 Ticket ，并且重定向用户到 CAS Client （附带刚才产生的 Service Ticket ）， Service Ticket 是不可以伪造的，最后， Step 5 和 Step6 是 CAS Client 和 CAS Server 之间完成了一个对用户的身份核实，用 Ticket 查到 Username ，因为 Ticket 是 CAS Server 产生的，因此，所以 CAS Server 的判断是毋庸置疑的。</p><p>​ 该协议完成了一个很简单的任务，就是用户(david.turing) 打开 IE ，直接访问 helloservice 应用，它被立即重定向到 CAS Server 进行认证， 用户可能感觉到浏览器在 helloservcie 和 casserver 之间重定向，但用户是看不到， CAS Client 和 CAS Server 相互间的 Service Ticket 核实 (Validation) 过程。当 CAS Server 告知 CAS Client 用户 Service Ticket 对应确凿身份， CAS Client 才会对当前 Request 的用户进行服务。</p><p>​ 另外，一节提到 Web 时代还处于初级阶段的时候， SSO 是通过共享 cookies 来实现，用到cookie必会由跨域问题。那CAS为什么不会有跨域问题呢？答案也很简单，CAS单点被控制在 CAS Server ，用户最有价值的 TGC-Cookie 只是跟 CAS Server 相关， CAS Server 就只有一个，因此，解决了 cookies 不能跨域的问题。</p><p>​ 回到 CAS 的基础协议图，当 Step3 完成之后， CAS Server 会向用户 发送一个 Ticket granting cookie (TGC) 给用户的浏览器，这个 Cookie 就类似 Kerberos 的 TGT ，下次当用户被 Helloservice2 重定向到 CAS Server 的时候， CAS Server 会主动 Get 到这个 TGC cookie ，然后做下面的事情：</p><ul><li>如果用户的持有 TGC 且其还没失效，那么就走基础协议图的 Step4 ，达到了 SSO 的效果。</li><li>如果 TGC 失效，那么用户还是要重新认证 ( 走基础协议图的 Step3) 。</li></ul><p>​ 详细流程可看查看附页。</p><h4 id="4-CAS代理模式"><a href="#4-CAS代理模式" class="headerlink" title="4. CAS代理模式"></a>4. CAS代理模式</h4><p>​ 模式 1 已经能够满足大部分简单的 SSO 应用，现在，我们探讨一种更复杂的情况，即用户访问 helloservice ， helloservice 又依赖于 helloservice2 来获取一些信息，如同： 用户 -&gt; helloservice -&gt; helloservice2（可以理解为：在一个应用群中，应用A需要获取其他应用的信息，此时应用A可以看成是用户，去单点登录访问其他应用信息。此时应用A也称为代理。代替用户去其他应用获取信息）；</p><p>​ 回到这里，这种情况下，假设 helloservice2 也是需要对用户进行身份验证才能访问， CAS 引入了一种 Proxy 认证机制，即 CAS Client 可以代理用户去访问其它 Web 应用。</p><p>​ 代理的前提是需要 CAS Client 拥有用户的身份信息 ( 类似凭据 ) 。与其说之前我们提到的 TGC 是用户持有对自己身份信息的一种凭据，则这里的 PGT 就是 CAS Client 端持有的对用户身份信息的一种凭据。凭借 TGC ，用户可以免去输入密码以获取访问其它服务的 Service Ticket ，所以这里，凭借 PGT ， Web 应用可以代理用户去实现后端的认证，而无需前端用户的参与。</p><p>​ 如下面的 CAS Proxy 图所示， CAS Client 在基础协议之上，提供了一个额外的 PGT URL 给 CAS Server, 于是， CAS Server 可以通过 PGT URL 提供一个 PGT 给 CAS Client 。</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/cas_protocol-2.jpg" alt="cas_protocol-2.jpg"></p><p>​ 于是， CAS Client 拿到了 PGT( PGTIOU-85…..ti2td ) ，这个 PGT 跟 TGC 同样地关键， CAS Client 可以通过 PGT 向后端 Web 应用进行认证。如下图所示， Proxy 认证与普通的认证其实差别不大， Step1, 2 与基础模式的 Step 1,2 几乎一样，唯一不同的是， Proxy 模式用的是 PGT 而不是 TGC ，是 Proxy Ticket （ PT ）而不是 Service Ticket 。</p><p>​ 最终的结果是， helloservice2 明白 helloservice 所代理的客户是 David. Turing 同学，同时，根据本地策略， helloservice2 有义务为 PGTURL=<a href="http://helloservice/proxy" target="_blank" rel="noopener">http://helloservice/proxy</a> 服务 (PGTURL 用于表示一个 Proxy 服务 ) ，于是它传递数据给 helloservice 。这样， helloservice 便完成一个代理者的角色，协助用户返回他想要的数据。</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/cas_protocol-3.jpg" alt="cas_protocol-3.jpg"></p><p>​ 代理认证模式非常有用，它也是 CAS 协议 v2 的一个最大的变化，这种模式非常适合在复杂的业务领域中应用 SSO 。因为，<strong>以前我们实施 SSO 的时候，都是假定以用户为 SSO 的访问者，忽视了业务系统作为 SSO 的访问者角色</strong>。</p><p>​ 详细流程可看查看附页</p><h4 id="5-CAS安全性"><a href="#5-CAS安全性" class="headerlink" title="5. CAS安全性"></a>5. CAS安全性</h4><h5 id="A-TGC-PGC的安全性"><a href="#A-TGC-PGC的安全性" class="headerlink" title="A. TGC/PGC的安全性"></a>A. TGC/PGC的安全性</h5><p>​ 于一个 CAS 用户来说，最重要是要保护它的 TGC （存在浏览器中），如果 TGC 不慎被 CAS Server 以外的实体获得， Hacker 能够冒充 CAS 用户访问所有授权资源。</p><p>​ SSO 的安全性问题比普通应用的安全性还要严重，因为 SSO 存在一种门槛效应。以前即使 Hacker 能够截获用户在 Web 应用 A 的密码，它也未必能知道用户在 Web 应用 B 的密码，但 SSO 让 Hacker 只需要截获 TGC( 突破了门槛 ) ，即能访问所有与该用户相关的所有应用系统。</p><p>​ PGT 跟 TGC 的角色是一样的，如果被 Hacker 获得，后果可想而知。</p><p>​ 从基础模式可以看出， TGC 是 CAS Server 通过 SSL 方式发送给终端用户，因此，要截取 TGC 难度非常大，从而确保 CAS 的安全性。因此，某些人认为 CAS 可以不使用 SSL 的想法需要更正一下， <strong>CAS 的传输安全性仅仅依赖于SSL</strong>（可以了解一下Http和Https协议） 。</p><p>​ TGC 也有自己的存活周期。下面是 CAS 的 web.xml 中，通过 grantingTimeout 来设置 CAS TGC 存活周期的参数，参数默认是 120 分钟，在合适的范围内设置最小值，太短，会影响 SSO 体验，太长，会增加安全性风险。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>edu.yale.its.tp.cas.grantingTimeout<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>7200<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure><p>​ TGC 面临的风险主要并非传输窃取。比如你登陆了之后，没有 Logout ，离开了电脑，别人就可以打开你的浏览器，直接访问你授权访问的应用 ，设置一个 TGC 的有效期，可以减少被别人盗用，或者被 Hacker 入侵你的电脑直接获取你系统目录下的 TGC Cookie 。</p><h5 id="B-Service-Ticket-Proxy-Ticket-安全性"><a href="#B-Service-Ticket-Proxy-Ticket-安全性" class="headerlink" title="B. Service Ticket/Proxy Ticket 安全性"></a>B. Service Ticket/Proxy Ticket 安全性</h5><p>​ 首先要知道，Service Ticket 是通过 Http 传送的，意味着所网络中的其他人可以捕获其他人的 Ticket 。</p><p>​ CAS 协议从几个方面让 Service Ticket 变得更加安全。</p><ul><li><p>Service Ticket 只能使用一次。</p><p>​ CAS 协议规定，无论 Service Ticket 验证是否成功， CAS Server 都会将服务端的缓存中清除该 Ticket ，从而可以确保一个 Service Ticket 被使用两次。</p></li><li><p>Service Ticket 在一段时间内失效。</p><p>​ 假设用户拿到 Service Ticket 之后，他请求 helloservice 的过程又被中断了， Service Ticket 就被空置了，事实上，此时， Service Ticket 仍然有效。 CAS 规定 Service Ticket 只能存活一定的时间，然后 CAS Server 会让它失效。通过在 web.xml 中配置下面的参数，可以让 Service Ticket 在多少秒内失效。该参数在业务应用的条件范围内，越小越安全。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>edu.yale.its.tp.cas.serviceTimeout<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>300<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>Service Ticket 是基于随机数生成的。</p><p>​ Service Ticket 必须足够随机，如果 Service Ticket 生成规则被猜出（如果你使用了 ST+Helloservice+ 自增序列的方式， Hacker 就可以构造下一个 Ticket ）， Hacker 就等于绕过 CAS 认证，直接访问所有服务。</p></li></ul><h2 id="附页"><a href="#附页" class="headerlink" title="附页"></a>附页</h2><p>CAS官方流程图解</p><h3 id="CAS基本协议模式"><a href="#CAS基本协议模式" class="headerlink" title="CAS基本协议模式"></a>CAS基本协议模式</h3><p>​ 官方的流程图非常详细，在具体的CAS单点登录流程我们可以看下图：</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/cas_flow_diagram.png" alt="CAS Web流程图"></p><p>​ 我们可以发现这里的流程与上一节SSO执行的基本是一致，只是CAS协议流程图中，更加清楚的指定了我们在访问过程当中的各种情况，在SSO中令牌也是我们在CAS中的ST(Service Ticket)。</p><p>​ 首先用户访问受保护的资源，权限没有认证，所以会把请求的URL以参数跳转到CAS认证中心，CAS认证中心发现没有SSO session，所以弹出登录页面，输入用户信息，提交到CAS认证中心进行信息的认证，如果信息正确，CAS认证中心就会创建一个SSO session和包含TGC的cookie给用户，同时服务端会分发一个ST返回给用户。用户拿到了ST后，访问带参数ST的资源地址，同时应用将ST发送给CAS认证中心，CAS认证中心对ST进行校验，同时判断相应的cookie（包含TGC）是否正确（通过先前设定的key），判断ST是否是有效的，结果会返回一个包含成功信息的XML给应用。应用在建立相应的session和cookie跳转到浏览器，用户再通过浏览器带cookie去应用访问受保护的资源地址，cookie和后端session验证成功便可以成功访问到信息。</p><p>​ 第二次访问应用时，浏览器就会携带相应的cookie信息，后台session验证用户是否登录，与一般单系统应用登录模式一样。</p><p>​ 当我们访问其他的应用，与前面的步骤也是基本相同，首先用户访问受保护的资源，跳转回浏览器，浏览器含有先前登录的CASTGC cookie，CASTGC cookie包含了TGT并发送到CAS认证中心，CAS认证中心校验TGT是否有效，如果有效分发浏览器一个带ST参数的资源地址URL，应用程序拿到ST后，再发送给CAS认证中心，如果认证了ST有效后，结果会返回一个包含成功信息的XML给应用。同样的步骤，应用在建立相应的session和cookie跳转到浏览器，用户再通过浏览器带cookie去应用访问受保护的资源地址，验证session成功便可以成功访问到信息。</p><h3 id="CAS代理模式"><a href="#CAS代理模式" class="headerlink" title="CAS代理模式"></a>CAS代理模式</h3><p>​ CAS协议的最强大的功能之一就是CAS服务可以作为另一个CAS服务的代理的能力，传输用户身份。</p><p>​ 同样的我们还是结合官方的流程图来分析：</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/cas_proxy_flow_diagram.jpg" alt="CAS 代理网络流程图"></p><p><strong>加载代理应用</strong></p><p>​ 首先用户访问代理地址，权限没有认证，所以会把请求的URL以参数跳转到CAS认证中心，CAS认证中心发现没有SSO session，所以弹出登录页面，输入用户信息，提交到CAS认证中心进行信息的认证，如果信息正确，CAS认证中心就会创建一个SSO session——CASTGC cookie，这个CASTGC cookie包含了TGT，这个TGT作为一个用户session，它会分发一个ST返回给用户。用户拿到了ST后，访问带参数ST的代理地址，代理地址将ST发送给CAS认证中心并且带一个pgtUrl，这是请求一个PGT的回调URL。CAS认证中通过调用回调PGT URL将TGT和PGTIOU传递给代理地址，代理地址匹配存储PGTIOU和PGT并执行下一步，然后CAS返回一个PGTIOU给代理匹配刚刚存储是PGTIOU与PGT是否一致。后面就通过PGTIOU查找PGT，然后代理地址在建立相应的session cookie跳转到浏览器，用户再通过浏览器带cookie去访问代理地址。</p><p><strong>通过代理访问应用</strong></p><p>​ 通过代理访问应用，在浏览器中通过携带相应的cookie去访问代理，然后验证session cookie的有效性，然后再代理地址通过PGT跳转到CAS认证中心，认证中心再通过代理地址访问应用，相同的步骤，应用发送ST给CAS认证中心，检验proxy ticket是否有效，如何有效返回给应用一个XML信息。在应用中查询代理URL是否可信赖，阻止代理用户非法的行为。然后应用再建立相应的session cookie跳转到代理地址，代理地址再带cookie去访问应用，并验证是否正确。如果正确，则应用响应代理地址的请求，代理地址再把请求发送给用户。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>​ 本节主要讲诉CAS基本模式和CAS代理模式的基本流程以及 CAS 的安全性的分析，文字堆积比较多，需要结合流程去理解和记忆。</p><p>​ 目前工作中遇见的CAS大多是不符合规范的，比如还留有原本登录接口，或者采用Http协议（Http协议是明文传输的，Https协议是在Http基础上加入SSL，而 CAS 的传输安全性又仅仅依赖于SSL )。反应各个系统不安全性的同时也说明大家更关注的其实是是否实现SSO，不会去纠结或者说没意识是否规范或者安全。这系统内部的安全保障大概就是程序员的职责所在吧。</p></div><footer class="article-footer"> <a data-url="https://blog.estralletommm.top/2021/10/27/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%BA%8C%E2%80%94%E2%80%94CAS/" data-id="cle6sor45001wdw9jhhandgt6" class="article-share-link">Share</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" rel="tag">单点登录</a></li></ul></footer></div></article><article id="post-单点登录一——原理" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"> <a href="/2021/10/26/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%B8%80%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86/" class="article-date"><time datetime="2021-10-26T00:56:04.000Z" itemprop="datePublished">2021-10-26</time></a><div class="article-category"> <a class="article-category-link" href="/categories/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/">单点登录</a></div></div><div class="article-inner"><header class="article-header"><h1 itemprop="name"> <a class="article-title" href="/2021/10/26/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%B8%80%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86/">单点登录一——原理</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="单点登录一原理"><a href="#单点登录一原理" class="headerlink" title="单点登录一原理"></a><center>单点登录一原理</center></h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>​ 公司经常会遇到单点登录类的业务，目前认知大多只是停留在应用层面。因此不论是对于公司业务还是自身发展，是有必要花时间整理一下的。</p><h2 id="正文："><a href="#正文：" class="headerlink" title="正文："></a>正文：</h2><h3 id="一、单系统登录机制"><a href="#一、单系统登录机制" class="headerlink" title="一、单系统登录机制"></a>一、单系统登录机制</h3><h4 id="1-http无状态协议"><a href="#1-http无状态协议" class="headerlink" title="1. http无状态协议"></a>1. http无状态协议</h4><p>​ web应用采一般用B/S架构，http/https作为通信协议。http是无状态协议，浏览器的每一次请求，服务器会独立处理，不与之前或之后的请求产生关联（做过前后分离的项目应该深有体会），这个过程用下图说明，三次请求/响应之间没有任何联系。</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/797930-20161129155231912-1627010726.png" alt="http无状态协议"></p><p>​ 那这就意味着，任何用户都能通过浏览器访问服务器资源，如果想保护服务器的某些资源，必须限制浏览器的请求。意思是必须鉴别浏览器请求，响应合法请求、忽略非法请求；要鉴别浏览器请求，必须清楚请求状态。既然http协议无状态，那就让服务器和浏览器共同维护一个状态吧！这就是会话机制。</p><h4 id="2-会话机制"><a href="#2-会话机制" class="headerlink" title="2. 会话机制"></a>2. 会话机制</h4><p>​ 浏览器第一次请求服务器，服务器创建了一个会话，并将会话的id作为响应的一部分发送给浏览器，浏览器会存储会话id，并在后续的第二次和第三次请求中带上会话id，服务器取得请求中的会话id就知道是不是同一个用户了，用如下图说明，后续请求与第一次请求产生了关联。</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/797930-20161129155233115-1744636093.png" alt="会话机制"></p><p>​ 服务器在内存中保存会话对象，浏览器怎么保存会话id呢？你可能会想到两种方式：</p><ul><li><p>请求参数；</p></li><li><p>cookie；</p><p>​ 将会话id作为每一次请求的参数，服务器接收请求自然能解析参数获得会话id，并借此判断是否来自同一会话，很显然，这种方式不太靠谱（个人认为，参数是用户方组织的，不可能要求用户维护id，每次请求再把id作为参数带上）。那就浏览器自己维护这个会话id吧，每次发http请求时浏览器自动发送会话id，cookie机制正好用来做这件事。cookie是浏览器用来存储少量数据的一种机制，数据以”key/value“形式存储，浏览器发请求时自动附带cookie信息。</p><p>我们常用的tomcat会话机制当然也实现了cookie，访问tomcat服务器时，浏览器中可以看到一个名为JSESSIONID的cookie，这就是tomcat会话机制维护的会话id，使用了cookie的请求响应过程如下图</p></li></ul><p> <img src="https://wisdomclass.tech/image/blog/20211027/797930-20161129155234443-99011212-1635232687315.png" alt="cookie请求"></p><h4 id="3-登录状态"><a href="#3-登录状态" class="headerlink" title="3. 登录状态"></a>3. 登录状态</h4><p>​ 有会话机制之后登录状态就很好理解了，我们假设浏览器第一次请求服务器需要输入用户名与密码验证身份，服务器拿到用户名密码去数据库比对，正确的话说明当前持有这个会话的用户是合法用户，应该将这个会话标记为“已授权”或者“已登录”等等之类的状态，既然是会话的状态，自然要保存在会话对象中，tomcat在会话对象中设置登录状态如下 :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HttpSession session = request.getSession();</span><br><span class="line">session.setAttribute(<span class="string">"isLogin"</span>, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><p>​ 用户再次访问时，tomcat再会话状态中查看登录状态</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HttpSession session = request.getSession();</span><br><span class="line">session.getAttribute(<span class="string">"isLogin"</span>);</span><br></pre></td></tr></table></figure><p>​ 实现了登录状态的浏览器请求服务器模型如下：</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/797930-20161129155235693-1708276896.png" alt="登录状态请求模型"></p><h3 id="二、多系统的复杂性"><a href="#二、多系统的复杂性" class="headerlink" title="二、多系统的复杂性"></a>二、多系统的复杂性</h3><p>​ web系统早已从久远的单系统发展成为如今由多系统组成的应用群，面对如此众多的系统，用户难道需要一个一个登录，然后一个一个注销吗？如下图：</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/797930-20161129155236615-855014039.png" alt="6dfbb0b1-46c0-4945-a3bf-5f060fa80710"></p><p>​ <strong>web系统由单系统发展成为所系统组成的应用群，复杂性应该由系统内部承担，而不是用户。</strong>无论web系统内部多么复杂，对于用户而言，都是一个统一的整体，也就是说，用户访问web系统整个应用群与访问单个系统一样，登录/注销一次就够了；</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/797930-20161129155237802-1969340065.png" alt="9fe14ab3-4254-447b-b850-0436e628c254"></p><p>​ 这时不难发现，上面讲到的单系统的登录解决方案已经不再使用于多系统应用群了。</p><p>​ 单系统登录解决方案的核心是cookie，cookie携带会话id在浏览器与服务器之间维护会话状态。但cookie有一个很大的限制，就是cookie的域（通常对应网站的域名），浏览器发送http请求会自动携带与该域匹配的cookie，而不是所有cookie。</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/797930-20161129155238881-1171826792.png" alt="4d58ccfa-0114-486d-bec2-c28f2f9eb513"></p><p>​ 既然这样，为什么不将web应用群中所有子系统的域名统一在一个顶级域名下，例如”*.baidu.com”，然后将他们的cookie域设置为“baidu.com”。这种做法理论上是可以的，甚至早期很多多系统登录就采用这种同域名共享cookie的方式。</p><p>​ 然而可行不代表好，共享cookie的方式存在众多局限。首先，应用群域名要统一；其次，应用群各系统使用的技术（至少是web服务器）要相同或者兼容的，不然cookie的key值（tomcat为JSESSIONID）不同，无法维持会话；第三，cookie本身的不安全的（依赖协议）。</p><p>​ 因此，我们需要一种全新的登录方式实现多系统应用群的登录，这就是单点登录。</p><h3 id="三、单点登录"><a href="#三、单点登录" class="headerlink" title="三、单点登录"></a>三、单点登录</h3><p>​ 认识单点登录之前，需要理清楚几个概念。</p><ul><li>什么是单点登录？单点登录全称Single Sign On（以下简称SSO），是指在多系统应用群中登录一个系统，便可在其他所有系统中得到授权而无需再次登录，包括单点登录与单点注销两部分 。</li><li>SSO<strong>不等于</strong>CAS。SSO更像是java接口类，仅仅是一种架构，一种设计；CAS就好比接口的实现类，是SSO的一种具体实现。两者是抽象与具体的关系。</li></ul><h4 id="1-登录"><a href="#1-登录" class="headerlink" title="1. 登录"></a>1. 登录</h4><p>​ 相比于单系统登录，sso需要一个独立的认证中心，只有认证中心能接受用户的用户名密码等安全信息，其他系统不提供登录入口，只接受认证中心的间接授权。间接授权通过令牌实现，sso认证中心验证用户的用户名密码没问题，创建授权令牌，在接下来的跳转过程中，授权令牌作为参数发送给各个子系统，子系统拿到令牌，即得到了授权，可以借此创建局部会话，局部会话登录方式与单系统的登录方式相同。这个过程，也就是单点登录的原理，用下图说明</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/797930-20161203152650974-276822362.png" alt="img"></p><p>下面对上图简要描述</p><ol><li>用户访问系统1的受保护资源，系统1发现用户未登录，跳转至sso认证中心，并将自己的地址作为参数；</li><li>sso认证中心发现用户未登录，将用户引导至登录页面；</li><li>用户输入用户名密码提交登录申请；</li><li>sso认证中心校验用户信息，创建用户与sso认证中心之间的会话，称为全局会话，同时创建授权令牌；</li><li>sso认证中心带着令牌跳转回最初的请求地址（系统1）；</li><li>系统1拿到令牌，去sso认证中心校验令牌是否有效；</li><li>sso认证中心校验令牌，返回有效，注册系统1；</li><li>系统1使用该令牌创建与用户的会话，称为局部会话，返回受保护资源；</li><li>用户访问系统2的受保护资源；</li><li>系统2发现用户未登录，跳转至sso认证中心，并将自己的地址作为参数；</li><li>sso认证中心发现用户已登录，跳转回系统2的地址，并附上令牌；</li><li>系统2拿到令牌，去sso认证中心校验令牌是否有效；</li><li>sso认证中心校验令牌，返回有效，注册系统2；</li><li>系统2使用该令牌创建与用户的局部会话，返回受保护资源；</li></ol><p>​ 用户登录成功之后，会与sso认证中心及各个子系统建立会话，用户与sso认证中心建立的会话称为全局会话，用户与各个子系统建立的会话称为局部会话，局部会话建立之后，用户访问子系统受保护资源将不再通过sso认证中心，全局会话与局部会话有如下约束关系：</p><ul><li><p>局部会话存在，全局会话一定存在</p></li><li><p>全局会话存在，局部会话不一定存在</p></li><li><p>全局会话销毁，局部会话必须销毁</p></li></ul><p>​ 通过上诉流程，我们可以看出简单的 SSO 的体系中，会有下面三种角色：</p><p>​ 1. User （浏览器，多个）</p><p>​ 2. Web 应用（多个）</p><p>​ 3. SSO 认证中心（ 1 个）</p><h4 id="2-注销"><a href="#2-注销" class="headerlink" title="2. 注销"></a>2. 注销</h4><p>​ 单点登录自然也要单点注销，在一个子系统中注销，所有子系统的会话都将被销毁，用下面的图来说明</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/797930-20161129155243068-1378377736.png" alt="3b139d2e-0b83-4a69-b4f2-316adb8997ce"></p><p>​ sso认证中心一直监听全局会话的状态，一旦全局会话销毁，监听器将通知所有注册系统执行注销操作</p><p>　下面对上图简要说明</p><ol><li>用户向系统1发起注销请求；</li><li>系统1根据用户与系统1建立的会话id拿到令牌，向sso认证中心发起注销请求；</li><li>sso认证中心校验令牌有效，销毁全局会话，同时取出所有用此令牌注册的系统地址；</li><li>sso认证中心向所有注册系统发起注销请求；</li><li>各注册系统接收sso认证中心的注销请求，销毁局部会话；</li><li>sso认证中心引导用户至登录页面；</li></ol><h4 id="3-部署"><a href="#3-部署" class="headerlink" title="3. 部署"></a>3. 部署</h4><p>​ 单点登录涉及sso认证中心与众子系统，子系统与sso认证中心需要通信以交换令牌、校验令牌及发起注销请求，因而子系统必须集成sso的客户端，sso认证中心则是sso服务端，整个单点登录过程实质是sso客户端与服务端通信的过程，用下图描述</p><p> <img src="https://wisdomclass.tech/image/blog/20211027/797930-20161129155244646-2067469767.png" alt="fb29685c-487c-42b9-9ceb-6c7ee29e98c9"></p><p>​ sso认证中心与sso客户端通信方式有多种，这里以简单好用的httpClient为例，web service、rpc、restful api都可以。</p><h4 id="4-分析"><a href="#4-分析" class="headerlink" title="4. 分析"></a>4. 分析</h4><p>​ 了解了SSO流程，我们就知道，SSO采用客户端/服务端架构 ，使用主要由两部分组成，并且功能如下：</p><ul><li>SSO-client<ol><li>拦截子系统未登录用户请求，跳转至sso认证中心；</li><li>接收并存储sso认证中心发送的令牌；</li><li>与sso-server通信，校验令牌的有效性；</li><li>建立局部会话；</li><li>拦截用户注销请求，向sso认证中心发送注销请求；</li><li>接收sso认证中心发出的注销请求，销毁局部会话。</li></ol></li><li>SSO-server<ol><li>验证用户的登录信息；</li><li>创建全局会话；</li><li>创建授权令牌；</li><li>与sso-client通信发送令牌；</li><li>校验sso-client令牌有效性；</li><li>系统注册；</li><li>接收sso-client注销请求，注销所有会话。</li></ol></li></ul><p>​ 了解客户端和服务端的主要功能以及流程后，我们自己也可以实现一个简易的单点登录示例，其中判断和拦截请求，用 servlet、filter、listener都能实现。值得一提的是用户在sso认证中心登录成功后，sso-server会创建授权令牌并存储该令牌，对令牌的校验就是去查找这个令牌是否存在以及是否过期。一般令牌与注册系统地址通常存储在key-value数据库（如redis）中，redis可以为key设置有效时间也就是令牌的有效期。redis运行在内存中，速度非常快，正好sso-server不需要持久化任何数据。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​ 本节主要讲述了从单系统登录到多系统登录再到单点登录的大致演变过程，着重讲解了单点登录的登录、注销流程，分析SSO客户端和SSO服务端各自职责。以小见大，其实每一种技术或者架构的产生都是解决之前问题为基础的。</p><p>​ 我个人是非常喜欢这种从整个演变了解一项技术的，它能解决我对现有技术很多“为什么？”的疑惑。但就身边大多朋友同事看来，大多关注的只是想了解的那一part，这种针对性强或者说关注结果的背后，总有点急于求成的感觉，是不利于个人长期发展的。我是能理解但是不赞同的。</p><p>​ 同时我在查找资料的过程中发现很多文章是5、6年前的，甚至有2006年的很好的技术文章。我一时不知该高兴当时大家对新技术的关注，还是伤感如今的自己还没有跟上技术潮流的步伐走在前端。最后也化作一句“技术和思想不会过时”来慰藉自己。</p></div><footer class="article-footer"> <a data-url="https://blog.estralletommm.top/2021/10/26/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%B8%80%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86/" data-id="cle6sor480023dw9j4hyj3a0x" class="article-share-link">Share</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" rel="tag">单点登录</a></li></ul></footer></div></article><article id="post-Oracle数据库安装以及数据泵还原" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"> <a href="/2021/09/06/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE%E6%B3%B5%E8%BF%98%E5%8E%9F/" class="article-date"><time datetime="2021-09-06T00:56:04.000Z" itemprop="datePublished">2021-09-06</time></a><div class="article-category"> <a class="article-category-link" href="/categories/oracle%E6%95%B0%E6%8D%AE%E5%BA%93/">oracle数据库</a></div></div><div class="article-inner"><header class="article-header"><h1 itemprop="name"> <a class="article-title" href="/2021/09/06/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE%E6%B3%B5%E8%BF%98%E5%8E%9F/">oracle数据库还原</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="Oracle12-2数据库安装和数据泵方式还原"><a href="#Oracle12-2数据库安装和数据泵方式还原" class="headerlink" title="Oracle12.2数据库安装和数据泵方式还原"></a>Oracle12.2数据库安装和数据泵方式还原</h1><h3 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h3><p>最近公司客户有一份Oracle12.2数据库备份需要还原，在联系客户支持和数据库人员都因版本和服务器等原因无法还原的情况下，决定自己本地还原。本地win10系统已经安装了Oracle11g，不打算卸载再重装12c，所以决定装个虚拟机运行12c版本并还原数据库。</p><h3 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h3><p>OS：CentOS 7</p><p>Oracle版本： 12.2（本人重装数据库亲身经历告诉大家：12.1版本和12.2版本都叫12c，这两个版本不能跨版本还原，你导出的数据库版本是12.2，就只能12.2版本还原！）</p><h3 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h3><h4 id="安装Oracle12-2"><a href="#安装Oracle12-2" class="headerlink" title="安装Oracle12.2"></a>安装Oracle12.2</h4><ol><li><h5 id="首先部署CentOS-7环境，如果你和我一样是装虚拟机，这部分百度已经很全面了。挂一个CentOS-7镜像文件（提取码：tom6），省的大家到处找。"><a href="#首先部署CentOS-7环境，如果你和我一样是装虚拟机，这部分百度已经很全面了。挂一个CentOS-7镜像文件（提取码：tom6），省的大家到处找。" class="headerlink" title="首先部署CentOS 7环境，如果你和我一样是装虚拟机，这部分百度已经很全面了。挂一个CentOS 7镜像文件（提取码：tom6），省的大家到处找。"></a>首先部署CentOS 7环境，如果你和我一样是装虚拟机，这部分百度已经很全面了。挂一个<a href="https://pan.baidu.com/s/1jmBXM55CRT_rTWQKA5xAdQ" target="_blank" rel="noopener">CentOS 7镜像文件</a>（提取码：tom6），省的大家到处找。</h5></li><li><h5 id="关闭防火墙，禁止防火墙开机自启动"><a href="#关闭防火墙，禁止防火墙开机自启动" class="headerlink" title="关闭防火墙，禁止防火墙开机自启动"></a>关闭<strong>防火墙</strong>，禁止防火墙开机自启动</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭防火墙</span></span><br><span class="line">systemctl stop firewalld.service </span><br><span class="line"><span class="comment"># 禁止防火墙开机启动</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br><span class="line"><span class="comment"># 查看防火墙状态</span></span><br><span class="line">systemctl status firewalld.service</span><br></pre></td></tr></table></figure></li><li><h5 id="关闭-selinux"><a href="#关闭-selinux" class="headerlink" title="关闭 selinux"></a>关闭 <strong>selinux</strong></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑文件</span></span><br><span class="line">vi /etc/selinux/config</span><br><span class="line"><span class="comment"># 修改内容</span></span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></table></figure></li><li><h5 id="通过yum安装必要的包"><a href="#通过yum安装必要的包" class="headerlink" title="通过yum安装必要的包"></a>通过yum安装必要的包</h5><ul><li>使用 yum 批量安装依赖包，若执行一遍失败则继续执行第二遍（多次执行不会出现其他问题）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#直接执行</span></span><br><span class="line">yum -y install binutils compat-libcap1 compat-libstdc++-33 compat-libstdc++-33*i686 compat-libstdc++-33*.devel compat-libstdc++-33 compat-libstdc++-33*.devel gcc gcc-c++ glibc glibc*.i686 glibc-devel glibc-devel*.i686 ksh libaio libaio*.i686 libaio-devel libaio-devel*.devel libgcc libgcc*.i686 libstdc++ libstdc++*.i686 libstdc++-devel libstdc++-devel*.devel libXi libXi*.i686 libXtst libXtst*.i686 make sysstat unixODBC unixODBC*.i686 unixODBC-devel unixODBC-devel*.i686</span><br></pre></td></tr></table></figure><ul><li>检查是否安装成功（31个安装包）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -q binutils compat-libcap1 compat-libstdc++-33 gcc gcc-c++ glibc glibc-devel ksh libaio libaio-devel libgcc libstdc++ libstdc++-devel libXi libXtst make sysstat unixODBC unixODBC-devel</span><br></pre></td></tr></table></figure></li><li><h5 id="设置时区、升级包软件和系统内核、安装桌面环境"><a href="#设置时区、升级包软件和系统内核、安装桌面环境" class="headerlink" title="设置时区、升级包软件和系统内核、安装桌面环境"></a>设置时区、升级包软件和系统内核、安装桌面环境</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置时区</span></span><br><span class="line">timedatectl <span class="built_in">set</span>-timezone Asia/Shanghai</span><br><span class="line"><span class="comment"># 升级系统</span></span><br><span class="line">yum clean all &amp;&amp; yum update -y</span><br><span class="line"><span class="comment"># 安装桌面环境（两个组包必须，不然安装oracle会出现卡死现象）</span></span><br><span class="line">yum groupinstall <span class="string">"GNOME Desktop"</span> <span class="string">"Server with GUI"</span> -y</span><br><span class="line"><span class="comment"># 安装完毕设置开机启动桌面环境</span></span><br><span class="line">systemctl <span class="built_in">set</span>-default graphical.target</span><br></pre></td></tr></table></figure></li><li><h5 id="创建oracle用户与用户组"><a href="#创建oracle用户与用户组" class="headerlink" title="创建oracle用户与用户组"></a>创建oracle用户与用户组</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建oinstall和dba组</span></span><br><span class="line">/usr/sbin/groupadd oinstall</span><br><span class="line">/usr/sbin/groupadd dba</span><br><span class="line"><span class="comment"># 创建oracle用户</span></span><br><span class="line">/usr/sbin/useradd -g oinstall -G dba oracle</span><br><span class="line"><span class="comment"># 设置oracle密码</span></span><br><span class="line">passwd oracle</span><br><span class="line"><span class="comment"># 查看创建结果</span></span><br><span class="line">id oracle</span><br></pre></td></tr></table></figure></li><li><h5 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置内核参数（这些参数根据你机器的配置不同，有些参数需要再次修改，在安装oralce过程中的check那一步，会给出提示，按要求逐个修改对应的推荐值即可）</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line">fs.aio-max-nr = 1048576</span><br><span class="line">fs.file-max = 6815744</span><br><span class="line">kernel.shmall = 2097152</span><br><span class="line">kernel.shmmax = 8329226240</span><br><span class="line">kernel.shmmni = 4096</span><br><span class="line">kernel.sem = 250 32000 100 128</span><br><span class="line">net.ipv4.ip_local_port_range = 9000 65500</span><br><span class="line">net.core.rmem_default = 262144</span><br><span class="line">net.core.rmem_max = 4194304</span><br><span class="line">net.core.wmem_default = 262144</span><br><span class="line">net.core.wmem_max = 1048586</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置ulimit参数</span></span><br><span class="line">vim /etc/security/limits.conf</span><br><span class="line">oracle soft nproc 65536</span><br><span class="line">oracle hard nproc 65536</span><br><span class="line">oracle soft nofile 65536</span><br><span class="line">oracle hard nofile 65536</span><br><span class="line">oracle soft stack 65536</span><br><span class="line">oracle hard stack 65536</span><br></pre></td></tr></table></figure></li><li><h5 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></table></figure></li><li><h5 id="下载或者拷贝oracle文件，挂一个这里用到的Oralce12-2版本（提取码：tom6），直接在CentOS中下载或者下载好拷贝进去都行。"><a href="#下载或者拷贝oracle文件，挂一个这里用到的Oralce12-2版本（提取码：tom6），直接在CentOS中下载或者下载好拷贝进去都行。" class="headerlink" title="下载或者拷贝oracle文件，挂一个这里用到的Oralce12.2版本（提取码：tom6），直接在CentOS中下载或者下载好拷贝进去都行。"></a>下载或者拷贝oracle文件，挂一个这里用到的<a href="https://pan.baidu.com/s/1UGVfeRLRbqeQea-2x2s8qA" target="_blank" rel="noopener">Oralce12.2版本</a>（提取码：tom6），直接在CentOS中下载或者下载好拷贝进去都行。</h5></li><li><h5 id="解压并开始安装，我下载到-opt-linuxx64-12201-database-zip"><a href="#解压并开始安装，我下载到-opt-linuxx64-12201-database-zip" class="headerlink" title="解压并开始安装，我下载到/opt/linuxx64_12201_database.zip"></a>解压并开始安装，我下载到<code>/opt/linuxx64_12201_database.zip</code></h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换到oracle用户</span></span><br><span class="line">su - oracle  </span><br><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line"><span class="comment"># 解压</span></span><br><span class="line">unzip linuxx64_12201_database.zip</span><br><span class="line"><span class="built_in">cd</span> database/</span><br><span class="line"><span class="comment"># 启动安装</span></span><br><span class="line">./runInstaller</span><br></pre></td></tr></table></figure><p>安装截图</p><p><img src="https://wisdomclass.tech/blog/20210807/20190928232206135.png" alt=""></p><p> <img src="https://wisdomclass.tech/blog/20210807/1628323614085.png" alt="在这里插入图片描述"></p><p> <img src="https://wisdomclass.tech/blog/20210807/20190928232222576.png" alt="在这里插入图片描述"></p><p> 填入密码，取消创建容器数据库<img src="https://wisdomclass.tech/blog/20210807/2019092823223235.png" alt="img"></p><p> <img src="https://wisdomclass.tech/blog/20210807/20190928232240275.png" alt="在这里插入图片描述"></p><p> <img src="https://wisdomclass.tech/blog/20210807/20190928232249397.png" alt="在这里插入图片描述"></p><p> <img src="https://wisdomclass.tech/blog/20210807/20190928232421526.png" alt="在这里插入图片描述"></p><p> <img src="https://wisdomclass.tech/blog/20210807/20190928232431342.png" alt="在这里插入图片描述"></p><p> <img src="https://wisdomclass.tech/blog/20210807/20190928232440772.png" alt="在这里插入图片描述"></p><p> <strong>出现这个窗口的时候，不要无脑的点击 OK了，请仔细看一下上面的提示，是要求你执行上面那两个命令的，所以把那两行命令在服务上执行一下，执行完毕后再点击OK（新开一个窗口，用 root 用户执行）。</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/u01/app/oraInventory/orainstRoot.sh</span><br><span class="line">/u01/app/oracle/product/12.2.0/dbhome_1/root.sh</span><br></pre></td></tr></table></figure><p>执行截图：</p><p> <img src="https://wisdomclass.tech/blog/20210807/20190928233347641.png" alt="在这里插入图片描述"></p><p> 如果你不小心无脑点击了OK，并没有执行那两行命令，就会出现下面这个警告，此时别着急点击 yes，先执行一下上面那2个命令，再点击 yes 也为时不晚。</p><p> <img src="https://wisdomclass.tech/blog/20210807/20190928232856986.png" alt="img"></p><p> <img src="https://wisdomclass.tech/blog/20210807/20190928233111505.png" alt="在这里插入图片描述"></p></li><li><h5 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">su - oracle</span><br><span class="line">vim ~/.bash_profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面环境变量配置内容，注意每一个路径都仔细检查一下不要错了,实际路径以你的安装路径为主</span></span><br><span class="line"><span class="built_in">export</span> EDITOR=vi</span><br><span class="line"><span class="built_in">export</span> ORACLE_SID=orcl</span><br><span class="line"><span class="built_in">export</span> ORACLE_BASE=/u01/app/oracle</span><br><span class="line"><span class="built_in">export</span> ORACLE_HOME=<span class="variable">$ORACLE_BASE</span>/product/12.2.0/dbhome_1</span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$ORACLE_HOME</span>/lib:/usr/lib</span><br><span class="line"><span class="built_in">export</span> PATH=/u01/app/oracle/product/12.2.0/dbhome_1/bin:/bin:/usr/bin:/usr/sbin:/usr/<span class="built_in">local</span>/bin:/usr/X11R6/bin</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$ORACLE_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行命令使环境变量生效</span></span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure></li><li><h5 id="登录数据库"><a href="#登录数据库" class="headerlink" title="登录数据库"></a>登录数据库</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 sqlplus 登录数据库</span></span><br><span class="line">sqlplus /nolog</span><br><span class="line">conn / as sysdba</span><br></pre></td></tr></table></figure></li></ol><p>至此安装数据库结束。</p><h4 id="数据泵还原"><a href="#数据泵还原" class="headerlink" title="数据泵还原"></a>数据泵还原</h4><ol><li><h5 id="用管理员账号登录，创建逻辑目录，并把要还原的dmp文件放在此目录下，我将dmp文件放在-opt-data目录下"><a href="#用管理员账号登录，创建逻辑目录，并把要还原的dmp文件放在此目录下，我将dmp文件放在-opt-data目录下" class="headerlink" title="用管理员账号登录，创建逻辑目录，并把要还原的dmp文件放在此目录下，我将dmp文件放在/opt/data目录下"></a>用管理员账号登录，创建逻辑目录，并把要还原的dmp文件放在此目录下，我将dmp文件放在<code>/opt/data</code>目录下</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 无用户进入</span></span><br><span class="line">sqlplus /nolog</span><br><span class="line"><span class="comment"># 连接sys账号，change_on_instal为初始密码</span></span><br><span class="line">conn sys/change_on_instal as sysdba;</span><br><span class="line">create or replace directory dmp as <span class="string">'/opt/data'</span></span><br></pre></td></tr></table></figure></li><li><h5 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grant all on directory dmp to public;</span><br></pre></td></tr></table></figure></li><li><h5 id="改变文件目录的权限"><a href="#改变文件目录的权限" class="headerlink" title="改变文件目录的权限"></a>改变文件目录的权限</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -r oracle:oinstall /opt/data</span><br></pre></td></tr></table></figure></li><li><h5 id="创建表空间、用户easytong，并授权（表空间和用户名需要和你还原的数据库保持一致）"><a href="#创建表空间、用户easytong，并授权（表空间和用户名需要和你还原的数据库保持一致）" class="headerlink" title="创建表空间、用户easytong，并授权（表空间和用户名需要和你还原的数据库保持一致）"></a>创建表空间、用户easytong，并授权（表空间和用户名需要和你还原的数据库保持一致）</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_AC <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_AC01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_AC02.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_AC03.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_AC04.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_AC05.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_AC_IDX <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_AC_IDX01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_AC_IDX02.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_BM <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_BM01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_BM_IDX <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_BM_IDX01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_BASIC <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_BASIC01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_BASIC02.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_BASIC03.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_BASIC04.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_BASIC_IDX <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_BASIC_IDX01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_BASIC_IDX02.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_CM <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM02.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM03.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM04.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM05.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM06.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_CM_IDX <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM_IDX01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM_IDX02.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM_IDX03.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM_IDX04.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM_IDX05.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CM_IDX06.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_CW <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CW01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_CW_IDX <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_CW_IDX01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_LOG <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_LOG01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_LOG_IDX <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_LOG_IDX01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_MONTH_PART <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_MONTH_PART01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_MONTH_PART02.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_MONTH_PART03.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_MONTH_PART04.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_MONTH_PART05.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_OM <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_OM01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_OM_IDX <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_OM_IDX01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">temporary</span> <span class="keyword">tablespace</span> ET_TEMP tempfile </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_TEMP01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_YEAR_PART <span class="keyword">datafile</span></span><br><span class="line"> <span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_YEAR_PART01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"> <span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_YEAR_PART02.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m,</span><br><span class="line"> <span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_YEAR_PART03.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_PX <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_PX01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> ET_PX_IDX <span class="keyword">datafile</span> </span><br><span class="line"><span class="string">'/home/oracle/app/oracle/oradata/orcl/ET_PX_IDX01.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>m <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">10</span>m;</span><br><span class="line"> </span><br><span class="line"><span class="comment">--drop user easytong cascade;</span></span><br><span class="line"><span class="keyword">alter</span> profile <span class="string">"DEFAULT"</span> <span class="keyword">limit</span> <span class="keyword">PASSWORD_GRACE_TIME</span> <span class="keyword">UNLIMITED</span>;</span><br><span class="line"><span class="keyword">alter</span> profile <span class="string">"DEFAULT"</span> <span class="keyword">limit</span> PASSWORD_LIFE_TIME <span class="keyword">UNLIMITED</span>;</span><br><span class="line"><span class="keyword">alter</span> profile <span class="string">"DEFAULT"</span> <span class="keyword">limit</span> <span class="keyword">PASSWORD_LOCK_TIME</span> <span class="keyword">UNLIMITED</span>;</span><br><span class="line"><span class="keyword">alter</span> profile <span class="string">"DEFAULT"</span> <span class="keyword">limit</span> <span class="keyword">FAILED_LOGIN_ATTEMPTS</span> <span class="keyword">UNLIMITED</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> easytong <span class="keyword">identified</span> <span class="keyword">by</span> <span class="number">310012</span> <span class="keyword">default</span> <span class="keyword">tablespace</span> et_basic <span class="keyword">temporary</span> <span class="keyword">tablespace</span> et_temp;</span><br><span class="line"><span class="comment">--grant create session,connect,resource,create any view,unlimited tablespace to easytong;</span></span><br><span class="line"><span class="keyword">grant</span> dba <span class="keyword">to</span> easytong;</span><br></pre></td></tr></table></figure></li><li><h5 id="新打开命令窗口，数据泵还原"><a href="#新打开命令窗口，数据泵还原" class="headerlink" title="新打开命令窗口，数据泵还原"></a>新打开命令窗口，数据泵还原</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># easytong是上一步创建的用户，310012是用户密码，orcl是实例（一般安装的时候没有改，这里orcl就可以），directory=文件路径，dmp是之前创建的逻辑目录，dumpfile=dmp文件名称，logfile=此次操作日志文件</span></span><br><span class="line">impdp easytong/310012@orcl directory=dmp dumpfile=expdp_20210322_030001.dmp logfile=import.log</span><br></pre></td></tr></table></figure></li></ol><p>数据还原到这里也结束了，看还原数据大小等待即可。</p><h3 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h3><p>Oracle作为大型数据库的b格还是在的，明显感觉到安装比mysql等其他中小型数据库难。另外Oracle中的用户、表空间、实例等这些概念也与其他数据库有异，深入理解还需要磨砺，共勉。</p></div><footer class="article-footer"> <a data-url="https://blog.estralletommm.top/2021/09/06/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE%E6%B3%B5%E8%BF%98%E5%8E%9F/" data-id="cle6sor3g000sdw9jbo99ei55" class="article-share-link">Share</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oracle/" rel="tag">oracle</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E6%B3%B5/" rel="tag">数据泵</a></li></ul></footer></div></article><article id="post-个性化开发总结_Tom" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"> <a href="/2021/06/23/%E4%B8%AA%E6%80%A7%E5%8C%96%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93_Tom/" class="article-date"><time datetime="2021-06-23T02:56:04.000Z" itemprop="datePublished">2021-06-23</time></a><div class="article-category"> <a class="article-category-link" href="/categories/%E6%98%93%E9%80%9A%E4%B8%AA%E6%80%A7%E5%8C%96%E5%BC%80%E5%8F%91/">易通个性化开发</a></div></div><div class="article-inner"><header class="article-header"><h1 itemprop="name"> <a class="article-title" href="/2021/06/23/%E4%B8%AA%E6%80%A7%E5%8C%96%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93_Tom/">易通个性化开发总结</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="个性化开发总结"><a href="#个性化开发总结" class="headerlink" title="个性化开发总结"></a><center>个性化开发总结</center></h1><h3 id="一、单点登录"><a href="#一、单点登录" class="headerlink" title="一、单点登录"></a>一、单点登录</h3><h4 id="门户单点登录"><a href="#门户单点登录" class="headerlink" title="门户单点登录"></a>门户单点登录</h4><p>1.和现场或者第三方确定具体的登录流程，大致分类两类：</p><ul><li>第三方应用访问门户页面（/index）——从请求中获取人员数据——通过人员数据进行登录操作；</li><li>第三方应用访问门户页面（/index）——跳转到认证平台获取授权后跳回——通过授权发送请求获取用户数据——登录操作；</li></ul><p>万变不离其宗的是通过各种手段方式获取用户数据，然后进行登录操作。</p><p>2.考虑是否需要过滤器常见的CAS、OAuth都有现成的过滤器可以使用，是需要在web.xml配置就好。他们的作用仅仅是拿到token，并不能得到用户数据。所以你还需要写一个自己的过滤器，用来通过token获取用户数据数据。登陆操作可以再过滤器中进行也可以在接口中进行，一般不要重复登录（很多token仅一次有效，第二次获取会失败），登录操作一般是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 门户网站登录</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> epId 使用单位编号</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> userNumber 个人编号/手机号/身份证号</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">cardAccountRmiService.portalLogin(Integer epId,String userNumber);</span><br></pre></td></tr></table></figure><p>3.很多单点不用过滤器就能进行，比如第一类流程，我获请求中参数并解密，得到用户信息即可登录。我在接口中新加一个获取perCode的方式即可实现单点登录：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/index"</span>, method = RequestMethod.GET)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">index1</span><span class="params">(HttpServletRequest req, HttpServletResponse resp, Model model)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		······</span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isBlank(userName)) &#123;</span><br><span class="line">            userName = httpServletRequest.getParameter(<span class="string">"userid"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 此处为我添加的代码  获取单点登录的参数</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtil.isBlank(userName)) &#123;</span><br><span class="line">            String token = httpServletRequest.getParameter(<span class="string">"token"</span>);</span><br><span class="line">            String info = Des3Utils.decrypt(KEY, IV, token);</span><br><span class="line">            JSONObject jsonObject = JSONObject.parseObject(info);</span><br><span class="line">            userName = jsonObject.getString(<span class="string">"workno"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 代码结束</span></span><br><span class="line">    	<span class="keyword">if</span> (<span class="keyword">null</span> == portalSession) &#123;</span><br><span class="line">    		<span class="keyword">try</span> &#123;</span><br><span class="line">    			Object[] objects = cardAccountRmiService.portalLogin(<span class="keyword">null</span>, userName);</span><br><span class="line">    			·····</span><br><span class="line">    		&#125;</span><br><span class="line">    	&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure><h4 id="H5单点登录"><a href="#H5单点登录" class="headerlink" title="H5单点登录"></a>H5单点登录</h4><p>1.同样需要确认登录流程，很多时候流程还与门户不一样，类型也大致分为两类，一类直接登录，另一类需要跳转认证，详情参考门户单点类型。</p><p>2.总体流程也和门户差不多，但是H5有一个已经配置好的拦截器H5ArgumentHandlerInterceptor，这里面已经有一些登录代码，需要在里面编码，获取用户信息并登录，并且登录成功后会把accNum和perCode放入request中。当执行具体的控制器接口时，不用重复获取用户信息，从request取出即可。</p><p>3.当登录成功后，会组织H5的访问参数，这个访问参数有必要说明一下：</p><p><img src="https://wisdomclass.tech/blog/20210623/image/image-20210622185821752.png" alt="image-20210622185821752"></p><p>​ 完整地址是：java<a href="http://系统地址/static/getAuthInfo.html?etToken=xxx&amp;jumpMod=xxx&amp;IDNo=xxx&amp;IDType=xxx&amp;allShowHead=1&amp;Epid=xxx" target="_blank" rel="noopener">http://系统地址/static/getAuthInfo.html?etToken=xxx&amp;jumpMod=xxx&amp;IDNo=xxx&amp;IDType=xxx&amp;allShowHead=1&amp;Epid=xxx</a></p><p>​ etToken是拼好的认证信息；jumpMod为要跳转的地址；IDNo为accNum或者perCode； IDType=4,代表IDNO为个人编号，IDType=1，代表IDNO为账号 并且经过三次base64加密；allShowHead=1为H5前端带顶部返回，allShowHead=0不带；Epid为园区号。</p><p>​ 注意：IDNo和IDType要对应，不然会有失败弹窗；顶部栏一般根据具体需要决定带不带；如果H5页面无法显示，可以在resources.properties配置里将h5.obscure设置为1后重试。</p><p>ps：下面是需要认证的获取perCode示例，先判断是否已经获取code，如果未获取就重定向到认证平台，用户输入用户名和密码后会携带code跳回到/login请求，如已获取就通过code发请求获取用户数据perCode，有了perCode就可以进行登录后续操作了。登出流程同理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">home</span><span class="params">(HttpServletRequest req, HttpServletResponse response)</span></span>&#123;</span><br><span class="line">    Map&lt;String, String[]&gt; map = req.getParameterMap();</span><br><span class="line">    String[] codes = map.get(<span class="string">"code"</span>);</span><br><span class="line">    <span class="keyword">if</span>(codes == <span class="keyword">null</span> || codes.length==<span class="number">0</span>) &#123;</span><br><span class="line">        String url = <span class="string">"https://ids.gszy.edu.cn/connect/authorize"</span>;</span><br><span class="line">        String sendUrl = url + <span class="string">"?client_id="</span>+clientId+<span class="string">"&amp;client_secret="</span>+clientSecrect+<span class="string">"&amp;response_type="</span>+responseType+<span class="string">"&amp;redirect_uri="</span>+redirectUri+<span class="string">"&amp;scope="</span>+scope;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.sendRedirect(sendUrl);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        String code = codes[<span class="number">0</span>];</span><br><span class="line">        String accessToken = getToken(code, <span class="string">"access_token"</span>,redirectUri);</span><br><span class="line">        <span class="keyword">if</span>(accessToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"token获取失败！"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//			获取用户信息</span></span><br><span class="line">        String url2 = <span class="string">"https://ids.gszy.edu.cn/connect/userinfo"</span>;</span><br><span class="line">        String results2 = send(url2,HttpMethod.POST,<span class="keyword">null</span>,MediaType.APPLICATION_JSON,accessToken);</span><br><span class="line">        JSONObject resultObj2 = <span class="keyword">new</span> JSONObject(results2);</span><br><span class="line">        <span class="keyword">return</span> resultObj2.getString(<span class="string">"perCode"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/logout"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">logout</span><span class="params">(HttpServletRequest req, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String redirectUriLogout = <span class="string">"http://localhost:8090/logout"</span>;</span><br><span class="line">    Map&lt;String, String[]&gt; map = req.getParameterMap();</span><br><span class="line">    String[] codes = map.get(<span class="string">"code"</span>);</span><br><span class="line">    String idToken2 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(codes == <span class="keyword">null</span> || codes.length==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//发送请求获取id_token</span></span><br><span class="line">        String url = <span class="string">"http://ids.gszy.edu.cn/connect/authorize"</span>;</span><br><span class="line">        String sendUrl = url + <span class="string">"?client_id="</span>+clientId+<span class="string">"&amp;client_secret="</span>+clientSecrect+<span class="string">"&amp;response_type="</span>+responseType+<span class="string">"&amp;redirect_uri="</span>+redirectUriLogout+<span class="string">"&amp;scope="</span>+scope;</span><br><span class="line">        response.sendRedirect(sendUrl);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        String code = codes[<span class="number">0</span>];</span><br><span class="line">        idToken2 = getToken(code, <span class="string">"id_token"</span>,redirectUriLogout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(idToken2 == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"token获取失败!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用注销</span></span><br><span class="line">    String url2 = <span class="string">"https://ids.gszy.edu.cn/connect/endsession?"</span>+<span class="string">"id_token_hint="</span>+idToken2+<span class="string">"&amp;post_logout_redirect_uri="</span>+redirectUri;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response.setHeader(<span class="string">"Content-type"</span>,<span class="string">"text/html;charset=utf-8"</span>);</span><br><span class="line">        response.sendRedirect(url2);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getToken</span><span class="params">(String code,String tokenType,String redirectUri)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//发送请求获取access_token</span></span><br><span class="line">    String url = <span class="string">"https://ids.gszy.edu.cn/connect/token"</span>;</span><br><span class="line">    MultiValueMap&lt;String, String&gt; params = <span class="keyword">new</span> LinkedMultiValueMap&lt;String, String&gt;();</span><br><span class="line">    params.set(<span class="string">"grant_type"</span>, <span class="string">"authorization_code"</span>);</span><br><span class="line">    params.set(<span class="string">"client_id"</span>, clientId);</span><br><span class="line">    params.set(<span class="string">"client_secret"</span>, clientSecrect);</span><br><span class="line">    params.set(<span class="string">"scope"</span>, scope);</span><br><span class="line">    params.set(<span class="string">"redirect_uri"</span>,redirectUri);</span><br><span class="line">    params.set(<span class="string">"code"</span>, code);</span><br><span class="line">    String result = send(url,HttpMethod.POST,params,MediaType.APPLICATION_FORM_URLENCODED,<span class="keyword">null</span>);</span><br><span class="line">    JSONObject resultObj = <span class="keyword">new</span> JSONObject(result);</span><br><span class="line">    String token = resultObj.getString(tokenType);</span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">(String url, HttpMethod method, MultiValueMap&lt;String, String&gt; params,MediaType contentType,String auth)</span> </span>&#123;</span><br><span class="line">    RestTemplate client = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">    <span class="keyword">if</span>(contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line">        headers.setContentType(contentType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(auth != <span class="keyword">null</span>) &#123;</span><br><span class="line">        headers.setBearerAuth(auth);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; requestEntity = <span class="keyword">new</span> HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt;(params, headers);</span><br><span class="line">    ResponseEntity&lt;String&gt; response = client.exchange(url, method, requestEntity, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">return</span> response.getBody();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="二、报表"><a href="#二、报表" class="headerlink" title="二、报表"></a>二、报表</h3><h4 id="增加新版本已删除的报表"><a href="#增加新版本已删除的报表" class="headerlink" title="增加新版本已删除的报表"></a>增加新版本已删除的报表</h4><p>1.在easytong_web/resource/auth/supported_functions.xml文件里查找对应报表名字，如果有该报表则不用修改，如没有该报表需要从有这个报表的版本这个文件拷贝过来，粘贴的位置与其保持一致，得到改报表的code值和url值。如下示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Function code=&quot;0200102&quot; name=&quot;科目报表&quot; ename=&quot;Subject report&quot; type=&quot;4&quot; url=&quot;/accsubjectdailyreport&quot; sort=&quot;1&quot; iconCls=&quot;menu_kemubb&quot; moduleCls=&quot;module_kemubb&quot;&gt;</span><br><span class="line">    &lt;Function code=&quot;020010201&quot; name=&quot;汇总&quot; type=&quot;5&quot; sort=&quot;0&quot; iconCls=&quot;menu_huizong&quot;/&gt;</span><br><span class="line">    &lt;Function code=&quot;020010202&quot; name=&quot;打印&quot; type=&quot;5&quot; sort=&quot;1&quot; iconCls=&quot;menu_kapiandy&quot;/&gt;</span><br><span class="line">&lt;/Function&gt;</span><br></pre></td></tr></table></figure><p>2.在easytong_commons/com/hzsun/easytong/commons/Contants.java文件中查找报表code值，处理与上一步相似，如有则不用修改，如没有则从有改报表的该文件中查找到并复制粘贴到对应的ModuleCode枚举类中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ACCSUBJECTDAILYREPORT(<span class="string">"0200102"</span>),ACCSUBJECTDAILYREPORT_QUERY(<span class="string">"020010201"</span>),ACCSUBJECTDAILYREPORT_PRINT(<span class="string">"020010202"</span>),<span class="comment">//科目报表</span></span><br></pre></td></tr></table></figure><p>3.在easytong_web中搜索url的值，如果能查找到对应类，则不需要改动（说明该版本没有删除该报表），如果没有，则从有这个报表的版本拷贝对应的controller文件放到对应文件夹下。</p><p>4.此时拷贝的controller文件大概率会爆红，需要一个一个导入对应的包解决，此时如果能完全解决则运气很好（说明服务里里面对应的报表没有删除）。如果xxxRmiService.xxx(xxx);方法爆红并提示无法解析方法，说明服务里面该表表需要的服务在这个版本已经删除，需要改动服务重新添加。如下图：</p><p><img src="https://wisdomclass.tech/blog/20210623/image/image-20210623084848493.png" alt="image-20210623084848493"></p><p>5.在服务中添加代码需要知道整个运行流程：Controller——Service——Dao——Mapper（严格意义上说，Mapper也是Dao层），service及以后就是核心服务所提供的。每一个service一般包括两个文件一个xxxService.java接口文件和一个xxxServiceImpl.java接口实现文件（名字xxx会对应相同）。dao层同理。mapper有点不一样，包括一个xxxMapper.java接口文件和一个对应的xxxMapper.xml文件，该文件存放了符合mybatis规范的sql代码。整体结构如下图：</p><p><img src="https://wisdomclass.tech/blog/20210623/image/image-20210623092652540.png" alt="image-20210623092652540"></p><p>6.不难发现，最坏情况需要改动6个文件！改动的方式也是通过从有该报表的项目拷贝缺失的具体方法，从service一层一层往下加不容易出错。</p><p>7.执行sql，在sc_module表中将对应报表的isauthority字段置为1（2表示删除，具体可查看数据库表）。并增加权限管理员可用。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 将该模块可用</span></span><br><span class="line"><span class="keyword">update</span> sc_module a <span class="keyword">set</span> a.isauthority=<span class="number">1</span> <span class="keyword">where</span> a.modulecode <span class="keyword">like</span> <span class="string">'%对应报表code值%'</span>;</span><br><span class="line"><span class="comment">-- 增加权限</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sc_dutyauthority(Dutynum,Modulecode) </span><br><span class="line"><span class="keyword">select</span> c.dutynum,a.MODULECODE <span class="keyword">from</span> sc_module a ,sc_duty c </span><br><span class="line"><span class="keyword">where</span> a.ISAUTHORITY=<span class="number">1</span> <span class="keyword">and</span> c.isinit = <span class="number">1</span> <span class="keyword">and</span> a.rangeFlag <span class="keyword">in</span> (<span class="number">1</span>) <span class="keyword">and</span> c.EPID &lt;&gt; <span class="number">0</span></span><br><span class="line"><span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span>(<span class="keyword">select</span> b.Modulecode <span class="keyword">from</span> sc_dutyauthority b <span class="keyword">where</span> b.modulecode=a.modulecode <span class="keyword">AND</span> c.dutynum = b.dutynum)</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> c.dutynum,a.MODULECODE <span class="keyword">from</span> sc_module a ,sc_duty c </span><br><span class="line"><span class="keyword">where</span> a.ISAUTHORITY=<span class="number">1</span> <span class="keyword">and</span> c.isinit = <span class="number">1</span> <span class="keyword">and</span> a.rangeFlag <span class="keyword">in</span> (<span class="number">0</span>) <span class="keyword">and</span> c.EPID = <span class="number">0</span></span><br><span class="line"><span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span>(<span class="keyword">select</span> b.Modulecode <span class="keyword">from</span> sc_dutyauthority b <span class="keyword">where</span> b.modulecode=a.modulecode <span class="keyword">AND</span> c.dutynum = b.dutynum)</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> b.dutynum,a.modulecode <span class="keyword">from</span> sc_module a,sc_duty b</span><br><span class="line"><span class="keyword">where</span> a.rangeflag=<span class="number">2</span> <span class="keyword">and</span> b.isinit = <span class="number">1</span> <span class="keyword">and</span> a.ISAUTHORITY=<span class="number">1</span></span><br><span class="line"><span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> sc_dutyauthority c</span><br><span class="line"><span class="keyword">where</span> a.modulecode=c.modulecode</span><br><span class="line"><span class="keyword">and</span> b.dutynum=c.dutynum</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>8.以上步骤都完成的情况下，即可查看报表是否正常。在给现场的补丁就是改动的Java文件生成的class字节码文件，部署仅需替换对应目录和包中文件。</p><p>ps：</p><pre><code>- 需要注意的是：easytong_api.jar、easytong_commons.jar是easytong_web和核心都用到了的包，改动之后web和核心都要替换。
- 其次注意的是改动的Contants.java这个文件里面是各种枚举类，每一个枚举类会被编译成单独的class文件，所以你会发现一个Contants.java文件编译之后会有多个对应class文件（如下图），我们需要替换现场的Contants.class和我们改动的ModuleCode枚举类生成的Constants$ModuleCode.class文件。
</code></pre><p><img src="https://wisdomclass.tech/blog/20210623/image/image-20210623095317749.png" alt="image-20210623095317749"></p><ul><li>这个是目前我采用的增加报表的方式，对然能达到目的，但是缺点很多：首先就是直接改动服务，在正规开发中改动原有的核心代码是大忌；其次就是改动的文件特别多，导致现场部署要替换的文件也特别多，部署麻烦并且增大个性化之间的冲突问题（顶掉别人的个性化）。之后可能会探索新加一个模块的方式来增加报表，上述问题应该也能得到优化。</li></ul><h3 id="三、开发外挂工具"><a href="#三、开发外挂工具" class="headerlink" title="三、开发外挂工具"></a>三、开发外挂工具</h3><h4 id="调用api接口实现补账"><a href="#调用api接口实现补账" class="headerlink" title="调用api接口实现补账"></a>调用api接口实现补账</h4><p>需求：一般现场系统故障，造成一部分人免费吃饭了，现在需要将这些人的钱扣回来。吃饭人员的信息已经有记录。</p><p>分析：这个工具的形式主观性就比较强了，当时想过用java写一个带图形界面的程序，或者用QT C++写一个类似桌面应用程序。后面想到功能实现可能是第一位的并且时间也比较紧，就写了一个maven项目。时间充裕当然可以写界面，这样现场用起来也比较简洁，体验感也会提升很多。</p><p>流程：</p><p>1.要调用易通系统，必须要在web对接系统模块下创建一个新应用得到appid和appsecret，每次调用接口之前要先通过appid和appsecret获取token，之后发请求都带上这个Token，才能认证通过调用成功。</p><p>2.读取指定目录下excel文件（excel当然也是我提供好的模板，现场插入数据就行）中的补账信息；</p><p>3.拼凑参数，为每条记录调用补账接口，进行补账；</p><p>4.统计失败记录信息，打印到日志。</p><p>ps：</p><ul><li>项目地址、对接系统appId 和 appSecret、excel路径等信息不能写死在程序，写在resources.properties文件中，通过读文件的方式读取具体值。</li><li>调用易通接口的工具都可以参考，工具地址： <a href="https://172.16.3.8/svn/Scm_SmartEP/trunk/04.平台个性化/10-0035 兰州交通大学/03-Codes/02-服务/兰州交通大学补账工具_GXH-007933" target="_blank" rel="noopener">https://172.16.3.8/svn/Scm_SmartEP/trunk/04.平台个性化/10-0035 兰州交通大学/03-Codes/02-服务/兰州交通大学补账工具_GXH-007933</a></li><li>还有一个思路就是不通过调api接口，你直接连接核心服务，通过调服务的方式进行补账。相比之下调接口比较灵活，省去了连核心的一堆配置。</li></ul><h3 id="四、数据同步"><a href="#四、数据同步" class="headerlink" title="四、数据同步"></a>四、数据同步</h3><p>​ 数据同步的方式也很多，需要和现场、第三方沟通确定。通过数据来源，目前来看可以分为连接数据库的数据同步和接口调用的数据同步，接口调用又分为调用别人的接口获取数据或者别人调用你提供的接口进行同步。</p><p>​ 其实整个数据同步的本质是不变的：获取数据然后调用服务同步信息</p><h4 id="调用第三方接口的数据同步"><a href="#调用第三方接口的数据同步" class="headerlink" title="调用第三方接口的数据同步"></a>调用第三方接口的数据同步</h4><p>1.首先要认识sync项目中的目录结构和文件作用。sync项目是一个标准的SpringBoot项目，不需要配置tomcat（SpringBoot项目内置tomcat）即可运行。controller文件夹放接口文件；easytong文件夹里面是封装的易通服务（在易通服务的基础上增加判断返回值等操作）；scheduler文件夹中放的是定时任务类；util文件夹放的是工具类，其中RmiClient.java的作用是连接核心服务并声明对应的Bean；HsfSyncApplication.java是启动类；resources中applocation.yml是遵循yml格式的配置文件；项目中assembly.xml是打包配置文件（可以修改包名日期，以及打包的文件过滤）；logback.xml是日志配置文件；pom.xml是maven配置文件。</p><p>2.调用接口并数据同步的逻辑代码写在定时任务SyncDataSchedulerService.java的syncData()方法中，可以通过注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scheduled</span>(cron = <span class="string">"$&#123;read.timer.parmas&#125;"</span>)</span><br></pre></td></tr></table></figure><p>​ 找到配置文件对应read.timer.parmas的值进行修改执行时间，时间参照cron格式。</p><p>3.在同步人员时，一定要确定唯一的对接字段（第三方和易通库都有的唯一字段），这个字段是一个桥梁，这样获取第三方数据之后，才能通过这个字段查询易通库里面的有没有这条记录，才确定是新增还是更新操作。</p><p>在同步部门时，我们的部门一般和第三方没有对应唯一字段，这个问题不要紧，大不了第一次同步就全部插入部门，易通库中老的部门不用了。但是在插入的时候可以把第三方的部门id存入thirdCode字段，当下一次获取到部门数据时，就可以通过thirdCode字段查找出数据库中是否存在这个部门。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 插入人员调用此方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">cardAccountRmiService.insertAccount(thirdExtendInfo, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 更新人员调用此方法</span></span><br><span class="line"><span class="comment">* 更新人员时，需要将设置AccNum和Checkflag字段</span></span><br><span class="line"><span class="comment">* thirdExtendInfo.setAccNum(AccNum);</span></span><br><span class="line"><span class="comment">* thirdExtendInfo.setCheckflag(true);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">cardAccountRmiService.updateAccount(thirdExtendInfo, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 插入部门调用此方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">accDepRmiService.insertDep(thirdDept, <span class="keyword">null</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 更新部门调用此方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">accDepRmiService.updateDep(thirdDept, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><p>4.编写完成后打包即可。</p><h4 id="提供接口的数据同步"><a href="#提供接口的数据同步" class="headerlink" title="提供接口的数据同步"></a>提供接口的数据同步</h4><p>​ 此类是第三方数据有变动之后，自动调用我们的对应接口，对易通库进行新增和更新操作。</p><p>1.和现场、第三方沟通，具体需要哪些接口？一般来说会有：插入人员接口、更新人员接口、插入部门接口、更新部门接口；</p><p>2.接口逻辑写在controller文件夹下，具体调用的方法与<code>调用第三方接口的数据同步</code>第三步中调用的方法相同；</p><p>3.完成后在需要确保第三放能够访问到项目并调用接口（可能涉及到外网地址的问题）；</p><p>4.完成打包即可。</p><p>参考项目： <a href="https://172.16.3.8/svn/Scm_SmartEP/trunk/04.平台个性化/10-0125 上海外国语大学附属外国语学校/03-Codes/02-服务/数据同步_GXH-007985" target="_blank" rel="noopener">https://172.16.3.8/svn/Scm_SmartEP/trunk/04.平台个性化/10-0125 上海外国语大学附属外国语学校/03-Codes/02-服务/数据同步_GXH-007985</a></p></div><footer class="article-footer"> <a data-url="https://blog.estralletommm.top/2021/06/23/%E4%B8%AA%E6%80%A7%E5%8C%96%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93_Tom/" data-id="cle6sor41001pdw9je541dta8" class="article-share-link">Share</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssm-java/" rel="tag">ssm java</a></li></ul></footer></div></article><article id="post-阿里面试题整理" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"> <a href="/2021/04/06/%E9%98%BF%E9%87%8C%E9%9D%A2%E8%AF%95%E9%A2%98%E6%95%B4%E7%90%86/" class="article-date"><time datetime="2021-04-06T00:56:04.000Z" itemprop="datePublished">2021-04-06</time></a><div class="article-category"> <a class="article-category-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></div></div><div class="article-inner"><header class="article-header"><h1 itemprop="name"> <a class="article-title" href="/2021/04/06/%E9%98%BF%E9%87%8C%E9%9D%A2%E8%AF%95%E9%A2%98%E6%95%B4%E7%90%86/">面试题目总结</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="阿里面试题整理"><a href="#阿里面试题整理" class="headerlink" title="阿里面试题整理"></a>阿里面试题整理</h1><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a><center>数据结构</center></h3><h4 id="跳跃链表"><a href="#跳跃链表" class="headerlink" title="跳跃链表"></a>跳跃链表</h4><p><img src="https://img-blog.csdnimg.cn/20200114180953884.png" alt="在这里插入图片描述"></p><p> 对有序链表建立类似索引的结构加快查找过程，跳跃链表基本上就是通过维护一个多层次的链表，每一层链表中的元素是前一层链表元素的子集</p><p><a href="https://blog.csdn.net/s_lisheng/article/details/103968891" target="_blank" rel="noopener">https://blog.csdn.net/s_lisheng/article/details/103968891</a></p><h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p><img src="https://wisdomclass.tech/image/blog/2021/0406/image-20210331103415088.png" alt="image-20210331103415088"></p><h4 id="ArrayList和数组"><a href="#ArrayList和数组" class="headerlink" title="ArrayList和数组"></a>ArrayList和数组</h4><ol><li>Array的空间大小是固定的，空间不够时也不能再次申请，所以需要事前确定合适的空间大小。ArrayList的空间是动态增长的，如果空间不够，它会创建一个空间比原空间大0.5倍的新数组，然后将所有元素复制到新数组中，接着抛弃旧数组。而且，每次添加新的元素的时候都会检查内部数组的空间是否足够。</li><li>ArrayList中存放的都是对象，即引用类型，即使我们可以向里面put一个基本数据类型，那么也是基于自动装箱特性，将基本数据类型转换成对象；而数组中可以是任意类型</li><li>ArrayList作为Array的增强版，当然是在方法上比Array多样化。比如添加全部addAll()、删除全部removeAll()、返回迭代器iterator()等。</li></ol><h3 id="计算机网络"><a href="#计算机网络" class="headerlink" title="计算机网络"></a><center>计算机网络</center></h3><h4 id="TCP四次挥手"><a href="#TCP四次挥手" class="headerlink" title="TCP四次挥手"></a>TCP四次挥手</h4><ol><li>客户端发送连接释放报文段，FIN=1，seq=u</li><li>服务器端回送确认报文段，ACK=1，seq=v，ack=u+1</li><li>服务器发完数据，就发出连接释放报文段，制动关闭。FIN=1，ACK=1，seq=w，ack=u+1</li><li>客户端回送一个确认报文段，等待sMSL（最长报文段寿命）后，彻底关闭连接。ACK=1，seq=u+1，ack=w+1</li></ol><h4 id="tcp的三次握手"><a href="#tcp的三次握手" class="headerlink" title="tcp的三次握手"></a>tcp的三次握手</h4><ol><li><p>客户端发送连接请求报文段，SYN=1，seq=x（随机）</p></li><li><p>服务器为TCP连接分配缓存和变量，并返回确认报文，SYN=1，ACK=1，seq=y（随机），ack=x+1</p></li><li><p>客户端为TCP连接分配缓存和变量，并向服务器端返回确认的确认，可以携带数据。SYN=0，ACK=1，seq=x+1，ack=y+1</p></li></ol><h4 id="IPv4和IPv6的区别"><a href="#IPv4和IPv6的区别" class="headerlink" title="IPv4和IPv6的区别"></a>IPv4和IPv6的区别</h4><ol><li>IPv4是32位IP地址，而IPv6是128位IP地址。IPv4是数字地址，用点分隔。IPv6是一个字母数字地址，用冒号分隔。</li><li><strong>地址类型。</strong>IPv4具有三种不同类型的地址：多播，广播和单播。IPv6还具有三种不同类型的地址：任意广播，单播和多播。</li><li><strong>数据包大小。</strong>对于IPv4，最小数据包大小为576字节。对于IPv6，最小数据包大小为1208字节。</li><li><strong>header区域字段数。</strong>IPv4具有12个标头字段，而IPv6支持8个标头字段。</li><li><strong>安全性。</strong>在IPv4中，安全性主要取决于网站和应用程序。它不是针对安全性而开发的IP协议。而IPv6集成了Internet协议安全标准（IPSec）。IPv6的网络安全不像IPv4是可选项，IPv6里的网络安全项是强制性的。</li></ol><h4 id="UDP和TCP区别"><a href="#UDP和TCP区别" class="headerlink" title="UDP和TCP区别"></a>UDP和TCP区别</h4><p>1、TCP面向连接（如打电话要先拨号建立连接）;UDP是无连接的，即发送数据之前不需要建立连接<br>2、TCP提供可靠的服务。也就是说，通过TCP连接传送的数据，无差错，不丢失，不重复，且按序到达;UDP尽最大努力交付，即不保 证可靠交付<br>3、TCP面向字节流，实际上是TCP把数据看成一连串无结构的字节流;UDP是面向报文的<br> UDP没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低（对实时应用很有用，如IP电话，实时视频会议等）<br>4、每一条TCP连接只能是点到点的;UDP支持一对一，一对多，多对一和多对多的交互通信<br>5、TCP首部开销20字节;UDP的首部开销小，只有8个字节<br>6、TCP的逻辑通信信道是全双工的可靠信道，UDP则是不可靠信道</p><h4 id="get和post的区别"><a href="#get和post的区别" class="headerlink" title="get和post的区别"></a>get和post的区别</h4><ol><li>GET把参数包含在URL中，POST通过request body传递参数。</li><li>GET请求在URL中传送的参数是有长度限制的，而POST么有。</li><li><p><strong>GET</strong>产生一个TCP数据包，浏览器会把http header和data一并发送出去，服务器响应200(返回数据);<strong>POST</strong>产生两个TCP数据包，浏览器先发送header，服务器响应100 continue，浏览器再发送data，服务器响应200 ok(返回数据)。</p><p>HTTP协议中的两种发送请求的方法 ， 都是基于TCP/IP关于数据如何在万维网中如何通信的协议</p></li></ol><h3 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a><center>操作系统</center></h3><h4 id="进程通信方式"><a href="#进程通信方式" class="headerlink" title="进程通信方式"></a>进程通信方式</h4><ol><li>管道（pipe）,流管道(s_pipe)和有名管道（FIFO）</li><li>信号(signal)</li><li>消息队列</li><li><strong>共享内存</strong></li><li><strong>信号量</strong></li><li><strong>套接字（socket)</strong></li></ol><h4 id="乐观锁、悲观锁"><a href="#乐观锁、悲观锁" class="headerlink" title="乐观锁、悲观锁"></a>乐观锁、悲观锁</h4><p>悲观锁每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会block直到它拿到锁。悲观锁：假定会发生并发冲突，屏蔽一切可能违反数据完整性的操作。</p><p>乐观锁每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据。乐观锁适用于多读的应用类型，这样可以提高吞吐量。</p><h4 id="Java的lock"><a href="#Java的lock" class="headerlink" title="Java的lock"></a>Java的lock</h4><p>jdk5之后的一个接口，主要解决synchronized的不足之处。</p><p>如果获取锁的线程由于要等待IO或者其他原因（比如调用sleep方法）被阻塞了，但是又没有释放锁，其他线程便只能干巴巴地等待，试想一下，这多么影响程序执行效率。因此就需要有一种机制可以不让等待的线程一直无期限地等待下去（比如只等待一定的时间或者能够响应中断），通过Lock就可以办到。</p><p>如果多个线程都只是进行读操作，所以当一个线程在进行读操作时，其他线程只能等待无法进行读操作。</p><h4 id="线程和进程的区别"><a href="#线程和进程的区别" class="headerlink" title="线程和进程的区别"></a>线程和进程的区别</h4><ol><li>进程是操作系统资源分配的基本单位，而线程是处理器任务调度和执行的基本单位</li><li>进程都有独立的代码和数据空间；同一类线程共享代码和数据空间，每个线程都有自己独立的运行栈和程序计数器，</li><li>进程切换时，消耗的资源大。线程之间切换的开销小。</li><li>每个独立的进程有程序运行的入口、顺序执行序列和程序出口。但是线程不能独立执行，必须依存在应用程序中，由应用程序提供多个线程执行控制，两者均可并发执行</li></ol><h4 id="数据库查询优化"><a href="#数据库查询优化" class="headerlink" title="数据库查询优化"></a>数据库查询优化</h4><ol><li><p>使用索引</p></li><li><p>用具体字段替代*</p></li><li><p>使用limit减少返回的行数，减少数据传输时间和带宽浪费</p></li><li><p>选择多核和主频高的CPU</p></li><li><p>内存优化：尽量多的内存分配给MySQL做缓存</p></li><li><p>MySQL配置文件配置最大连接数、缓存大小等</p></li><li><p>使用数据库连接池</p></li><li><p>使用查询缓存</p></li></ol><h4 id="如何避免死锁"><a href="#如何避免死锁" class="headerlink" title="如何避免死锁"></a>如何避免死锁</h4><p><strong>死锁原因：</strong></p><p>互斥条件：一个资源每次只能被一个线程使用。</p><p>请求与保持条件：一个线程因请求资源而阻塞时，对已获得的资源保持不放。</p><p>不剥夺条件：线程已获得的资源，在未使用完之前，不能强行剥夺。</p><p>循环等待条件：若干线程之间形成一种头尾相接的循环等待资源关系。</p><p><strong>避免：</strong></p><ol><li>破坏请求和保持条件：在系统中不允许进程在已获得某种资源的情况下，申请其他资源，即要想出一个办法，阻止进程在持有资源的同时申请其它资源。</li><li>破坏不可抢占条件：允许对资源实行抢夺。</li><li>破坏循环等待条件</li></ol><h3 id="javaSE"><a href="#javaSE" class="headerlink" title="javaSE"></a><center>javaSE</center></h3><h4 id="Spring了解多少"><a href="#Spring了解多少" class="headerlink" title="Spring了解多少"></a>Spring了解多少</h4><p>通过封装和自动装配让javaweb项目开发的更简单</p><p>Ioc控制反转</p><p>IOC容器，每个类在xml配置文件中注册一个bean，后面可以用java代码和注解代替。我们获取applicationContext获取容器，之后通过容器获取注入的bean，进行操作。</p><p>AOP面向切面编程，静态动态代理，反射</p><h4 id="c-c-java的区别"><a href="#c-c-java的区别" class="headerlink" title="c\c++\java的区别"></a>c\c++\java的区别</h4><ol><li>C++ 支持指针，而 Java 没有指针的概念。</li><li>C++ 支持多继承，而 Java 不支持多重继承，但允许一个类实现多个接口。</li><li>Java 是完全面向对象的语言，并且还取消了 C/C++ 中的结构和联合，使编译程序更加简洁</li><li>Java 自动进行无用内存回收操作，不再需要程序员进行手动删除，而 C++ 中必须由程序释放内存资源，这就增加了程序员的负担。</li><li>Java 不支持操作符重载，操作符重载则被认为是 C++ 的突出特征。</li><li>Java 允许预处理，但不支持预处理器功能，所以为了实现预处理，它提供了引入语句（import），但它与 C++ 预处理器的功能类似。</li><li>Java 不支持缺省参数函数，而 C++ 支持 。</li><li>C 和 C++ 不支持字符串变量，在 C 和 C++ 程序中使用“Null”终止符代表字符串的结束。在 Java 中字符串是用类对象（String 和 StringBuffer）来实现的</li><li>goto 语句是 C 和 C++ 的“遗物”，Java 不提供 goto 语句，虽然 Java 指定 goto 作为关键字，但不支持它的使用，这使程序更简洁易读。</li><li>Java 不支持 C++ 中的自动强制类型转换，如果需要，必须由程序显式进行强制类型转换。</li></ol><h4 id="接口和抽象类的区别"><a href="#接口和抽象类的区别" class="headerlink" title="接口和抽象类的区别"></a>接口和抽象类的区别</h4><ol><li>接口只有定义，<strong>不能有方法的实现</strong>，而抽象类可以有定义与实现，方法可在抽象类中实现</li><li>实现接口的关键字为<code>implements</code>，继承抽象类的关键字为<code>extends</code>。一个类<strong>可以实现多个接口</strong>，但一个类只能继承一个抽象类。所以，使用接口可以间接地实现多重继承。</li><li>接口成员变量默认为<code>public static final</code>，<strong>必须赋初值</strong>，不能被修改； 抽象类中成员变量默认<code>default</code>，可在子类中被重新定义，也可被重新赋值</li><li>接口不能包含构造器，抽象类可以包含<strong>构造器</strong>，抽象类里的构造器并不是用于创建对象，而是<strong>让其子类调用这些构造器</strong>来<strong>完成</strong>属于<strong>抽象类的初始化操作</strong></li></ol><h4 id="jvm的内存模型"><a href="#jvm的内存模型" class="headerlink" title="jvm的内存模型"></a>jvm的内存模型</h4><p> <img src="https://pic4.zhimg.com/80/v2-abefb713de46f1e6dd241246c0afe263_720w.jpg" alt="img"></p><ul><li>堆（Heap）：线程共享。所有的对象实例以及数组都要在堆上分配。回收器主要管理的对象。</li><li>方法区（Method Area）：线程共享。存储类信息、常量、静态变量、即时编译器编译后的代码。</li><li>方法栈（JVM Stack）：线程私有。存储局部变量表、操作栈、动态链接、方法出口，对象指针。</li><li>本地方法栈（Native Method Stack）：线程私有。为虚拟机使用到的Native 方法服务。如Java使用c或者c++编写的接口服务时，代码在此区运行。</li><li>程序计数器（Program Counter Register）：线程私有。有些文章也翻译成PC寄存器（PC Register），同一个东西。它可以看作是当前线程所执行的字节码的行号指示器。指向下一条要执行的指令。</li></ul><h4 id="jvm的垃圾回收机制和垃圾回收算法"><a href="#jvm的垃圾回收机制和垃圾回收算法" class="headerlink" title="jvm的垃圾回收机制和垃圾回收算法"></a>jvm的垃圾回收机制和垃圾回收算法</h4><p> GC采用有向图的方式记录和管理堆(heap)中的所有对象。通过这种方式确定哪些对象是”可达的”，哪些对象是”不可达的”。当GC确定一些对象为”不可达”时，GC就有责任回收这些内存空间。</p><p>回收机制：</p><p><strong>引用计数器法</strong>：为每个对象创建一个引用计数，有对象引用时计数器 +1，引用被释放时计数 -1，当计数器为 0 时就可以被回收。但是他有一个缺点是不能解决循环引用的问题。</p><p><strong>可达性分析算法</strong>：从 GC Roots 开始向下搜索，搜索所走过的路径称为引用链。当一个对象到 GC Roots 没有任何引用链相连时，则证明此对象是可以被回收的。</p><p>当对象对当前使用这个对象的应用程序变得不可触及的时候，这个对象就可以被回收了。</p><p>回收算法：</p><p> <strong>标记-清除算法</strong>：标记无用对象，然后进行清除回收。</p><p> <strong>标记-整理算法</strong>：标记无用对象，让所有存活的对象都向一端移动，然后直接清除掉端边界以外的内存。</p><p> <strong>复制算法</strong>：按照容量划分二个大小相等的内存区域，当一块用完的时候将活着的对象复制到另一块上，然后再把已使用的内存空间一次清理掉。缺点：内存使用率不高，只有原来的一半。</p><h4 id="springboot原理"><a href="#springboot原理" class="headerlink" title="springboot原理"></a>springboot原理</h4><p>对Spring的再封装， 通过注解简化配置文件，快速构建web应用。</p><p> 自动装配</p><p> SpringBoot将所有的常见开发功能，分成了一个个场景启动器（starter），这样我们需要开发什么功能，就导入什么场景启动器依赖即可。</p><h4 id="消息中间件"><a href="#消息中间件" class="headerlink" title="消息中间件"></a>消息中间件</h4><p> 是利用高效可靠的消息传递机制进行异步的数据传输。通过提供消息队列模型和消息传递机制，可以在分布式环境下扩展进程间的通信。</p><p> 应用程序之间不采取直接通信，而是使用消息中间作为中介，做到数据的异步通信。开发人员不需要考虑网络协议和远程调用的问题，只需要通过各消息中间件所提供的api，就可以简单的完成消息推送，和消息接收的业务功能。</p><p> 消息的生产者将消息存储到队列中，消息的消费者不一定马上消费消息，可以等到自己想要用到这个消息的时候，再从相应的队列中去获取消息。这样的设计可以很好的解决，大数据量数据传递所占用的资源，使数据传递和平台分开，不再需要分资源用于数据传输，可以将这些资源用去其他想要做的事情上。</p><h4 id="Java中常见的集合有哪些，那些线程安全，那些线程不安全"><a href="#Java中常见的集合有哪些，那些线程安全，那些线程不安全" class="headerlink" title="Java中常见的集合有哪些，那些线程安全，那些线程不安全"></a>Java中常见的集合有哪些，那些线程安全，那些线程不安全</h4><p>集合有List、ArrayList、set、HashSet、TreeSet、Map、HashMap</p><p> Vector、HashTable、Properties是线程安全的；</p><p> ArrayList、LinkedList、HashSet、TreeSet、HashMap、TreeMap等都是线程不安全的。</p><p>java.util.concurrent，ConcurrentHashMap，CopyOnWriteArrayList和CopyOnWriteArraySet线程安全的实现类。</p><h4 id="hashmap是否为线程安全的，为什么不安全？"><a href="#hashmap是否为线程安全的，为什么不安全？" class="headerlink" title="hashmap是否为线程安全的，为什么不安全？"></a>hashmap是否为线程安全的，为什么不安全？</h4><ul><li>JDK1.7 中，由于多线程对HashMap进行扩容，调用了HashMap#transfer()，具体原因：某个线程执行过程中，被挂起，其他线程已经完成数据迁移，等CPU资源释放后被挂起的线程重新执行之前的逻辑，数据已经被改变，造成死循环、数据丢失。</li><li>JDK1.8 中，由于多线程对HashMap进行put操作，调用了HashMap#putVal()，具体原因：假设两个线程A、B都在进行put操作，并且hash函数计算出的插入下标是相同的，当线程A执行完第六行代码后由于时间片耗尽导致被挂起，而线程B得到时间片后在该下标处插入了元素，完成了正常的插入，然后线程A获得时间片，由于之前已经进行了hash碰撞的判断，所有此时不会再进行判断，而是直接进行插入，这就导致了线程B插入的数据被线程A覆盖了，从而线程不安全。</li></ul><h3 id="数据库"><a href="#数据库" class="headerlink" title=" 数据库"></a><center> 数据库</center></h3><h4 id="数据库执行引擎了解吗"><a href="#数据库执行引擎了解吗" class="headerlink" title="数据库执行引擎了解吗"></a>数据库执行引擎了解吗</h4><p>Myisam：MySQL5.5之前使用，不支持事务，不支持行锁（是表锁），不支持外键，支持全文索引，查找快，存储文件小。</p><p>InnoDb：支持事务，支持行锁，支持外键可以多表查询，不支持全文索引，文件存储大。</p><h4 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h4><ol><li>读未提交（READ UNCOMMITTED）</li><li>读提交 （READ COMMITTED）</li><li>可重复读 （REPEATABLE READ）</li><li><p>串行化 （SERIALIZABLE）</p><p><img src="https://pic4.zhimg.com/80/v2-2e1a7203478165890e2d09f36cb39857_720w.jpg" alt="img"></p></li></ol></div><footer class="article-footer"> <a data-url="https://blog.estralletommm.top/2021/04/06/%E9%98%BF%E9%87%8C%E9%9D%A2%E8%AF%95%E9%A2%98%E6%95%B4%E7%90%86/" data-id="cle6sor4h002fdw9j5qj331sr" class="article-share-link">Share</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul></footer></div></article><article id="post-SQL语句总结" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"> <a href="/2021/03/22/SQL%E8%AF%AD%E5%8F%A5%E6%80%BB%E7%BB%93/" class="article-date"><time datetime="2021-03-22T06:56:04.000Z" itemprop="datePublished">2021-03-22</time></a><div class="article-category"> <a class="article-category-link" href="/categories/SQL/">SQL</a></div></div><div class="article-inner"><header class="article-header"><h1 itemprop="name"> <a class="article-title" href="/2021/03/22/SQL%E8%AF%AD%E5%8F%A5%E6%80%BB%E7%BB%93/">SQL语句总结</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="SQL语句总结"><a href="#SQL语句总结" class="headerlink" title="SQL语句总结"></a><center>SQL语句总结</center></h1><h2 id="一、选择语句"><a href="#一、选择语句" class="headerlink" title="一、选择语句"></a>一、选择语句</h2><h3 id="REGEXP"><a href="#REGEXP" class="headerlink" title="REGEXP"></a>REGEXP</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">WHERE</span> last_name REGEXP <span class="string">'[a-h]e'</span></span><br><span class="line"><span class="comment">-- ^ 开始</span></span><br><span class="line"><span class="comment">-- $ end </span></span><br><span class="line"><span class="comment">-- | 逻辑上的 or</span></span><br><span class="line"><span class="comment">-- [asd]</span></span><br><span class="line"><span class="comment">-- [a-f]</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> customers</span><br><span class="line"><span class="comment">-- WHERE first_name REGEXP 'elka|ambur'</span></span><br><span class="line"><span class="comment">-- WHERE last_name REGEXP 'EY$|ON$'</span></span><br><span class="line"><span class="comment">-- WHERE last_name REGEXP '^MY|SE'</span></span><br><span class="line"><span class="comment">-- WHERE last_name REGEXP 'B[RU]'</span></span><br></pre></td></tr></table></figure><h3 id="IS-NULL"><a href="#IS-NULL" class="headerlink" title="IS NULL"></a>IS NULL</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">WHERE</span> shipper_id <span class="keyword">IS</span> <span class="literal">NULL</span></span><br><span class="line"><span class="comment">-- WHERE shipper_id IS NOT NULL</span></span><br></pre></td></tr></table></figure><h3 id="ORDER-BY"><a href="#ORDER-BY" class="headerlink" title="ORDER BY"></a>ORDER BY</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> first_name <span class="keyword">DESC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在其他数据库会报错，因为排序列不在select内，但是MySQL可以支持</span></span><br><span class="line"><span class="keyword">SELECT</span> first_name, last_name</span><br><span class="line"><span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> birth_date</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> first_name, last_name, <span class="number">10</span> <span class="keyword">AS</span> points</span><br><span class="line"><span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">1</span>, <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *, quantity * unit_price <span class="keyword">AS</span> total_price</span><br><span class="line"><span class="keyword">FROM</span> order_items</span><br><span class="line"><span class="keyword">WHERE</span> order_id = <span class="number">2</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> total_price <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure><h3 id="LIMIT"><a href="#LIMIT" class="headerlink" title="LIMIT"></a>LIMIT</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询结果保留前6项</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询6之后的三项（分页），LIMIT 偏移量，取出项数</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">LIMIT</span> <span class="number">6</span>, <span class="number">3</span></span><br></pre></td></tr></table></figure><h2 id="二、连接"><a href="#二、连接" class="headerlink" title="二、连接"></a>二、连接</h2><h3 id="INNER-JOINS"><a href="#INNER-JOINS" class="headerlink" title="INNER JOINS"></a>INNER JOINS</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 表名后面可以用别名替代 orders o</span></span><br><span class="line"><span class="comment">-- JOIN后要用ON指定通过哪一项进行连接表 o.customer_id = c.customer_id</span></span><br><span class="line"><span class="comment">-- select中查询两张表都有的项时，要指明是哪一个表中的项 o.customer_id</span></span><br><span class="line"><span class="comment">-- INNER可以省略</span></span><br><span class="line"><span class="keyword">SELECT</span> order_id, o.customer_id, first_name, last_name</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> customers c</span><br><span class="line">	<span class="keyword">ON</span> o.customer_id = c.customer_id</span><br></pre></td></tr></table></figure><h3 id="JOINING-ACROSS-database-跨数据库连接"><a href="#JOINING-ACROSS-database-跨数据库连接" class="headerlink" title="JOINING ACROSS database 跨数据库连接"></a>JOINING ACROSS database 跨数据库连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 连接时，不在该数据库中的表加上数据库前缀即可</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> sql_store.order_items o</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> products p</span><br><span class="line">	<span class="keyword">ON</span> o.product_id = p.product_id</span><br></pre></td></tr></table></figure><h3 id="Self-Joins-自连接"><a href="#Self-Joins-自连接" class="headerlink" title="Self Joins 自连接"></a>Self Joins 自连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 同一张表连接，要取两个别名，注意是哪一项的值进行表连接，这里对染都是Employees表，但是通过 e.reports_to = m.employee_id 进行连接</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	e.employee_id,</span><br><span class="line">	e.first_name,</span><br><span class="line">    m.first_name <span class="keyword">AS</span> manager</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">JOIN</span> employees m</span><br><span class="line">	<span class="keyword">ON</span> e.reports_to = m.employee_id</span><br></pre></td></tr></table></figure><h3 id="Joining-Multiple-Tables-多表连接"><a href="#Joining-Multiple-Tables-多表连接" class="headerlink" title="Joining Multiple Tables 多表连接"></a>Joining Multiple Tables 多表连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 连接一个表后再次连接一个表，此时都是与order表进行连接</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	o.order_id,</span><br><span class="line">    o.order_date,</span><br><span class="line">    c.first_name,</span><br><span class="line">    c.last_name,</span><br><span class="line">    os.name <span class="keyword">AS</span> <span class="keyword">status</span></span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> customers c</span><br><span class="line">	<span class="keyword">ON</span> o.customer_id = c.customer_id</span><br><span class="line"><span class="keyword">JOIN</span> order_statuses os</span><br><span class="line">	<span class="keyword">ON</span> o.status = os.order_status_id</span><br></pre></td></tr></table></figure><h3 id="Compound-Join-Conditions-复合连接条件"><a href="#Compound-Join-Conditions-复合连接条件" class="headerlink" title="Compound Join Conditions 复合连接条件"></a>Compound Join Conditions 复合连接条件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 表中有多个主键，连接表时加 AND 规定多个项对应</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> order_items oi</span><br><span class="line"><span class="keyword">JOIN</span> order_item_notes oin</span><br><span class="line">	<span class="keyword">ON</span> oi.order_id = oin.order_id</span><br><span class="line">    <span class="keyword">AND</span> oi.product_id = oin.product_id</span><br></pre></td></tr></table></figure><h3 id="Implicit-Join-Syntax-隐式连接语法"><a href="#Implicit-Join-Syntax-隐式连接语法" class="headerlink" title="Implicit Join Syntax 隐式连接语法"></a>Implicit Join Syntax 隐式连接语法</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 隐式连接更方便，但是不建议使用</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> customers c</span><br><span class="line">	<span class="keyword">ON</span> o.customer_id = c.customer_id=</span><br><span class="line"><span class="comment">-- 隐式连接语法</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> orders o, customers c</span><br><span class="line"><span class="keyword">WHERE</span> o.customer_id = c.customer_id</span><br></pre></td></tr></table></figure><h3 id="Outer-Joins-外连接"><a href="#Outer-Joins-外连接" class="headerlink" title="Outer Joins 外连接"></a>Outer Joins 外连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 使用JOIN时，代表内连接，此时返回 c.customer_id = o.customer_id 也就是所有有订单的客户信息</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	c.customer_id,</span><br><span class="line">    c.first_name,</span><br><span class="line">    o.order_id</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> customers c</span><br><span class="line">	<span class="keyword">ON</span> c.customer_id = o.customer_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> c.customer_id</span><br><span class="line"><span class="comment">-- LEFT JOIN 或者 RIGHT JOIN 为外连接，左连接会以左表为准，返回左表所有的值，此时就会显示，所有客户的订单情况，即使他没有下单（无订单情况）</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	c.customer_id,</span><br><span class="line">    c.first_name,</span><br><span class="line">    o.order_id</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> customers c</span><br><span class="line">	<span class="keyword">ON</span> c.customer_id = o.customer_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> c.customer_id</span><br></pre></td></tr></table></figure><h3 id="Outer-Join-Between-Multiple-Tables-多表外连接"><a href="#Outer-Join-Between-Multiple-Tables-多表外连接" class="headerlink" title="Outer Join Between Multiple Tables 多表外连接"></a>Outer Join Between Multiple Tables 多表外连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 同样使用多个LEFT JOIN 连接</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	c.customer_id,</span><br><span class="line">    c.first_name,</span><br><span class="line">    o.order_id,</span><br><span class="line">    sh.name <span class="keyword">AS</span> shipper</span><br><span class="line"><span class="keyword">FROM</span> customers c</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> orders o</span><br><span class="line">	<span class="keyword">ON</span> c.customer_id = o.customer_id</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> shippers sh</span><br><span class="line">	<span class="keyword">ON</span> o.shipper_id = sh.shipper_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> c.customer_id</span><br></pre></td></tr></table></figure><h3 id="Self-Outer-Joins-自外连接"><a href="#Self-Outer-Joins-自外连接" class="headerlink" title="Self Outer Joins 自外连接"></a>Self Outer Joins 自外连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 可以显示出所有employees中的人，其中包含reports_to为空的人</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	e.employee_id,</span><br><span class="line">    e.first_name,</span><br><span class="line">    m.first_name <span class="keyword">AS</span> manager</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees m</span><br><span class="line">	<span class="keyword">ON</span> e.reports_to = m.employee_id</span><br></pre></td></tr></table></figure><h3 id="The-Using-Clause-USING子句"><a href="#The-Using-Clause-USING子句" class="headerlink" title="The Using Clause USING子句"></a>The Using Clause USING子句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 当ON 比较的项名相同时，可以用USING简化，内外连接都可以用</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	o.order_id,</span><br><span class="line">    c.first_name,</span><br><span class="line">    sh.name <span class="keyword">AS</span> shipper</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">JOIN</span> customers c</span><br><span class="line">	<span class="comment">-- ON o.customer_id = c.customer_id</span></span><br><span class="line">	<span class="keyword">USING</span> (customer_id)</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> shippers sh</span><br><span class="line">	<span class="keyword">USING</span> (shipper_id)</span><br><span class="line"><span class="comment">-- 同理，复合条件连接在USING中加入两个项</span></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> order_items oi</span><br><span class="line"><span class="keyword">JOIN</span> order_item_notes oin</span><br><span class="line"><span class="comment">-- 	ON oi.order_id = oin.order_id</span></span><br><span class="line"><span class="comment">--  AND oi.product_id = oin.product_id</span></span><br><span class="line">	<span class="keyword">USING</span> (order_id, product_id)</span><br></pre></td></tr></table></figure><h3 id="Natural-Joins-自然连接"><a href="#Natural-Joins-自然连接" class="headerlink" title="Natural Joins 自然连接"></a>Natural Joins 自然连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 不用打上列名，数据库引擎会自己寻找相同的列进行连接。因为不可控，不建议使用。</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	o.order_id,</span><br><span class="line">	c.first_name</span><br><span class="line"><span class="keyword">FROM</span> orders o</span><br><span class="line"><span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> customers c</span><br></pre></td></tr></table></figure><h3 id="Cross-Joins-交叉连接"><a href="#Cross-Joins-交叉连接" class="headerlink" title="Cross Joins 交叉连接"></a>Cross Joins 交叉连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- customers表中每一项与products表中每一项结合</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	c.first_name,</span><br><span class="line">    p.name <span class="keyword">AS</span> product</span><br><span class="line"><span class="keyword">FROM</span> customers c</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">JOIN</span> products p</span><br><span class="line"><span class="comment">-- 隐式写法</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	c.first_name,</span><br><span class="line">    p.name <span class="keyword">AS</span> product</span><br><span class="line"><span class="keyword">FROM</span> customers c, products p</span><br></pre></td></tr></table></figure><h3 id="Unions-联合"><a href="#Unions-联合" class="headerlink" title="Unions 联合"></a>Unions 联合</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 合并多段查询的记录，需要保证列数量一样</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	customer_id,</span><br><span class="line">    first_name,</span><br><span class="line">    points,</span><br><span class="line">    <span class="string">'Bronze'</span> <span class="keyword">AS</span> <span class="keyword">type</span></span><br><span class="line"><span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">WHERE</span> points &lt; <span class="number">2000</span></span><br><span class="line"><span class="keyword">UNION</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	customer_id,</span><br><span class="line">    first_name,</span><br><span class="line">    points,</span><br><span class="line">    <span class="string">'Sliver'</span> <span class="keyword">AS</span> <span class="keyword">type</span></span><br><span class="line"><span class="keyword">FROM</span> customers</span><br><span class="line"><span class="keyword">WHERE</span> points <span class="keyword">BETWEEN</span> <span class="number">2000</span> <span class="keyword">AND</span> <span class="number">3000</span></span><br></pre></td></tr></table></figure><h2 id="三、列属性"><a href="#三、列属性" class="headerlink" title="三、列属性"></a>三、列属性</h2><h3 id="Inserting-a-Row-插入单行"><a href="#Inserting-a-Row-插入单行" class="headerlink" title="Inserting a Row 插入单行"></a>Inserting a Row 插入单行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> customers (first_name, last_name, birth_date, address, city, state)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">'John'</span>, <span class="string">'Smith'</span>, <span class="string">'1990-01-01'</span>, <span class="string">'address'</span>, <span class="string">'city'</span>, <span class="string">'CA'</span>)</span><br></pre></td></tr></table></figure><h3 id="Insert-Multiple-Rows-插入多行"><a href="#Insert-Multiple-Rows-插入多行" class="headerlink" title="Insert Multiple Rows 插入多行"></a>Insert Multiple Rows 插入多行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> products(<span class="keyword">name</span>, quantity_in_stock, unit_price)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">'p1'</span>, <span class="number">0</span>, <span class="number">0</span>), (<span class="string">'p2'</span>, <span class="number">0</span>, <span class="number">0</span>), (<span class="string">'p3'</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure><h3 id="Inserting-Hierarchical-Rows-插入分层行"><a href="#Inserting-Hierarchical-Rows-插入分层行" class="headerlink" title="Inserting Hierarchical Rows 插入分层行"></a>Inserting Hierarchical Rows 插入分层行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在母表插入后需要获取生成的id插入子表中。LAST_INSERT_ID()获取新生成的id</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders (customer_id, order_date, <span class="keyword">status</span>)</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'2019-01-01'</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> order_items</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="keyword">LAST_INSERT_ID</span>(), <span class="number">1</span>, <span class="number">1</span>, <span class="number">2.95</span>), (<span class="keyword">LAST_INSERT_ID</span>(), <span class="number">2</span>, <span class="number">1</span>, <span class="number">2.95</span>)</span><br></pre></td></tr></table></figure><h3 id="Creating-a-Copy-of-a-Table-创建表复制"><a href="#Creating-a-Copy-of-a-Table-创建表复制" class="headerlink" title="Creating a Copy of a Table 创建表复制"></a>Creating a Copy of a Table 创建表复制</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 复制orders表到orders_archived表，该复制不会设置新表中的主键和自动递增。</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> orders_archived <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> orders</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将订单日期小于2019-01-01的记录全部插入orders_archived表中</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders_archived</span><br><span class="line"><span class="keyword">SELECT</span> * </span><br><span class="line"><span class="keyword">FROM</span> orders</span><br><span class="line"><span class="keyword">WHERE</span> order_date &lt; <span class="string">'2019-01-01'</span></span><br></pre></td></tr></table></figure><h3 id="Updating-a-Single-Row-更新单行"><a href="#Updating-a-Single-Row-更新单行" class="headerlink" title="Updating a Single Row 更新单行"></a>Updating a Single Row 更新单行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 可以通过表内的值计算再复制</span></span><br><span class="line"><span class="keyword">UPDATE</span> invoices</span><br><span class="line"><span class="keyword">SET</span> </span><br><span class="line">	payment_total = invoice_total * <span class="number">0.5</span>, </span><br><span class="line">    payment_date = due_date</span><br><span class="line"><span class="keyword">WHERE</span> invoice_id = <span class="number">3</span></span><br></pre></td></tr></table></figure><h3 id="Updating-Multiple-Rows-更新多行"><a href="#Updating-Multiple-Rows-更新多行" class="headerlink" title="Updating Multiple Rows 更新多行"></a>Updating Multiple Rows 更新多行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 通过条件 更新多行</span></span><br><span class="line"><span class="keyword">UPDATE</span> invoices</span><br><span class="line"><span class="keyword">SET</span> </span><br><span class="line">	payment_total = invoice_total * <span class="number">0.5</span>, </span><br><span class="line">    payment_date = due_date</span><br><span class="line"><span class="keyword">WHERE</span> client_id <span class="keyword">IN</span>(<span class="number">3</span>, <span class="number">4</span>)</span><br></pre></td></tr></table></figure><h3 id="Using-Subqueries-in-Updates-在Updates中使用子查询"><a href="#Using-Subqueries-in-Updates-在Updates中使用子查询" class="headerlink" title="Using Subqueries in Updates 在Updates中使用子查询"></a>Using Subqueries in Updates 在Updates中使用子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 当子查询结果有多个时，使用IN接收</span></span><br><span class="line"><span class="keyword">UPDATE</span> invoices</span><br><span class="line"><span class="keyword">SET</span> </span><br><span class="line">	payment_total = invoice_total * <span class="number">0.5</span>,</span><br><span class="line">    payment_date = due_date</span><br><span class="line"><span class="keyword">WHERE</span> client_id <span class="keyword">IN</span> </span><br><span class="line">				(<span class="keyword">SELECT</span> client_id</span><br><span class="line">				<span class="keyword">FROM</span> clients</span><br><span class="line">				<span class="keyword">WHERE</span> state <span class="keyword">IN</span> (<span class="string">'CA'</span>, <span class="string">'NY'</span>))</span><br></pre></td></tr></table></figure><h3 id="Deleting-Rows-删除行"><a href="#Deleting-Rows-删除行" class="headerlink" title="Deleting Rows 删除行"></a>Deleting Rows 删除行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 如果不用WHERE是删除表中所有数据，WHERE中任然可以使用子查询</span></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> invouces</span><br><span class="line"><span class="keyword">WHERE</span> clients_id <span class="keyword">IN</span>(</span><br><span class="line">				<span class="keyword">SELECT</span> clients_id</span><br><span class="line">				<span class="keyword">FROM</span> clients</span><br><span class="line">				<span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'Myworks'</span>)</span><br></pre></td></tr></table></figure><h2 id="四、聚合函数"><a href="#四、聚合函数" class="headerlink" title="四、聚合函数"></a>四、聚合函数</h2><h3 id="Aggregate-Functions-聚合函数"><a href="#Aggregate-Functions-聚合函数" class="headerlink" title="Aggregate Functions 聚合函数"></a>Aggregate Functions 聚合函数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 还可以计算日期、字符串。</span></span><br><span class="line"><span class="comment">-- 只计算列中的非空值，统计全部数量可以用*号</span></span><br><span class="line"><span class="comment">-- 先执行表达式，再执行函数</span></span><br><span class="line"><span class="comment">-- 去除重复项用DISTINCT关键字</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	<span class="keyword">MAX</span>(invoice_total) <span class="keyword">AS</span> highest,</span><br><span class="line">    <span class="keyword">MIN</span>(invoice_total) <span class="keyword">AS</span> lowest,</span><br><span class="line">    <span class="keyword">AVG</span>(invoice_total) <span class="keyword">AS</span> average,</span><br><span class="line">    <span class="keyword">SUM</span>(invoice_total * <span class="number">1.1</span>) <span class="keyword">AS</span> total,</span><br><span class="line">    <span class="keyword">COUNT</span>(invoice_total) <span class="keyword">AS</span> number_of_invoices,</span><br><span class="line">    <span class="keyword">COUNT</span>(payment_date) <span class="keyword">AS</span> count_of_payments,</span><br><span class="line">    <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> total_records,</span><br><span class="line">    <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> client_id) <span class="keyword">AS</span> total_records</span><br><span class="line"><span class="keyword">FROM</span> invoices</span><br><span class="line"><span class="keyword">WHERE</span> invoice_date &gt; <span class="string">'2019_07_01'</span></span><br></pre></td></tr></table></figure><h3 id="The-GROUP-BY-Clause-GROUP-BY-句子"><a href="#The-GROUP-BY-Clause-GROUP-BY-句子" class="headerlink" title="The GROUP BY Clause | GROUP BY 句子"></a>The GROUP BY Clause | GROUP BY 句子</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- group by 常用在sum()之后，作用是根据一个或多个列对结果集进行分组</span></span><br><span class="line"><span class="comment">-- 注意各个关键词的位置</span></span><br><span class="line"><span class="keyword">SELECT</span>  </span><br><span class="line">	client_id,</span><br><span class="line">	<span class="keyword">sum</span>(invoice_total) <span class="keyword">AS</span> total_sales</span><br><span class="line"><span class="keyword">from</span> invoices</span><br><span class="line"><span class="keyword">where</span> invoice_date &gt;= <span class="string">'2019-07-01'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> client_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> total_sales <span class="keyword">DESC</span></span><br><span class="line"><span class="comment">-- 多个列对结果进行分组</span></span><br><span class="line"><span class="keyword">SELECT</span>  </span><br><span class="line">	state,</span><br><span class="line">    city,</span><br><span class="line">	<span class="keyword">sum</span>(invoice_total) <span class="keyword">AS</span> total_sales</span><br><span class="line"><span class="keyword">from</span> invoices i</span><br><span class="line"><span class="keyword">join</span> clients c <span class="keyword">using</span>(client_id)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> state, city</span><br></pre></td></tr></table></figure><h3 id="The-HAVING-Clause-HAVING-句子"><a href="#The-HAVING-Clause-HAVING-句子" class="headerlink" title="The HAVING Clause | HAVING 句子"></a>The HAVING Clause | HAVING 句子</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- HAVING 在分组后筛选数据（WHERE无法分组筛选后的数据）</span></span><br><span class="line"><span class="comment">-- HAVING 中的项必须是select中的项</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	c.customer_id,</span><br><span class="line">	c.first_name,</span><br><span class="line">    c.last_name,</span><br><span class="line">    <span class="keyword">sum</span>(oi.quantity * oi.unit_price) <span class="keyword">AS</span> total_sales</span><br><span class="line"><span class="keyword">from</span> customers c</span><br><span class="line"><span class="keyword">join</span> orders o</span><br><span class="line">	<span class="keyword">using</span>(customer_id)</span><br><span class="line"><span class="keyword">join</span> order_items oi</span><br><span class="line">	<span class="keyword">using</span>(order_id)</span><br><span class="line"><span class="keyword">where</span> state = <span class="string">'VA'</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">	c.customer_id,</span><br><span class="line">	c.first_name,</span><br><span class="line">    c.last_name</span><br><span class="line"><span class="keyword">having</span> total_sales &gt; <span class="number">100</span></span><br></pre></td></tr></table></figure><h3 id="The-ROLLUP-Operator-ROLLUP运算符（MySQL特有）"><a href="#The-ROLLUP-Operator-ROLLUP运算符（MySQL特有）" class="headerlink" title="The ROLLUP Operator | ROLLUP运算符（MySQL特有）"></a>The ROLLUP Operator | ROLLUP运算符（MySQL特有）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- with rollup只能用于聚合函数，为group by中的每一组合求和</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	state,</span><br><span class="line">    city,</span><br><span class="line">    <span class="keyword">sum</span>(invoice_total) <span class="keyword">AS</span> total_sales</span><br><span class="line"><span class="keyword">from</span> invoices i</span><br><span class="line"><span class="keyword">join</span> clients c <span class="keyword">using</span>(client_id)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> state, city <span class="keyword">with</span> <span class="keyword">rollup</span></span><br></pre></td></tr></table></figure><h2 id="五、子查询"><a href="#五、子查询" class="headerlink" title="五、子查询"></a>五、子查询</h2><h3 id="Subquerise-子查询"><a href="#Subquerise-子查询" class="headerlink" title="Subquerise 子查询"></a>Subquerise 子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- where中的子查询</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	employee_id,</span><br><span class="line">    first_name</span><br><span class="line"><span class="keyword">from</span> employees</span><br><span class="line"><span class="keyword">where</span> salary &gt; (</span><br><span class="line">	<span class="keyword">select</span> <span class="keyword">avg</span>(salary)</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h3 id="The-IN-Operator-IN-运算符子查询"><a href="#The-IN-Operator-IN-运算符子查询" class="headerlink" title="The IN Operator | IN 运算符子查询"></a>The IN Operator | IN 运算符子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 子查询返回一列值时，用IN接收</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> products</span><br><span class="line"><span class="keyword">where</span> product_id <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">select</span> <span class="keyword">distinct</span> product_id</span><br><span class="line">	<span class="keyword">from</span> order_items</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h3 id="Subquerise-vs-Joins-子查询-vs-连接"><a href="#Subquerise-vs-Joins-子查询-vs-连接" class="headerlink" title="Subquerise vs Joins | 子查询 vs 连接"></a>Subquerise vs Joins | 子查询 vs 连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 先考虑执行效率，再考虑可读性。这里推荐使用连接查询</span></span><br><span class="line"><span class="comment">-- 子查询</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	customer_id, </span><br><span class="line">    first_name,</span><br><span class="line">    last_name</span><br><span class="line"><span class="keyword">from</span> customers</span><br><span class="line"><span class="keyword">where</span> customer_id <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">select</span> <span class="keyword">distinct</span> customer_id</span><br><span class="line">	<span class="keyword">from</span> orders</span><br><span class="line">	<span class="keyword">where</span> order_id <span class="keyword">IN</span> (</span><br><span class="line">		<span class="keyword">select</span> order_id</span><br><span class="line">		<span class="keyword">from</span> order_items</span><br><span class="line">		<span class="keyword">where</span> product_id = <span class="number">3</span></span><br><span class="line">		)</span><br><span class="line">	)</span><br><span class="line"><span class="comment">-- 连接查询</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">distinct</span> c.customer_id,</span><br><span class="line">    c.first_name,</span><br><span class="line">    c.last_name</span><br><span class="line"><span class="keyword">from</span> customers c</span><br><span class="line"><span class="keyword">join</span> orders o <span class="keyword">using</span>(customer_id)</span><br><span class="line"><span class="keyword">join</span> order_items oi <span class="keyword">using</span>(order_id)</span><br><span class="line"><span class="keyword">where</span> product_id = <span class="number">3</span></span><br></pre></td></tr></table></figure><h3 id="The-ALL-Keyword-ALL关键字"><a href="#The-ALL-Keyword-ALL关键字" class="headerlink" title="The ALL Keyword | ALL关键字"></a>The ALL Keyword | ALL关键字</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- all是代表括号内的所有值</span></span><br><span class="line"><span class="comment">-- 当返回的是一条或者多条数据时用all（因为比较符不能直接比较多个值）</span></span><br><span class="line"><span class="comment">-- all可以与max相互转换</span></span><br><span class="line"><span class="comment">-- max查询</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> invoices</span><br><span class="line"><span class="keyword">where</span> invoice_total &gt; (</span><br><span class="line">	<span class="keyword">select</span> <span class="keyword">max</span>(invoice_total)</span><br><span class="line">	<span class="keyword">from</span> invoices</span><br><span class="line">	<span class="keyword">where</span> client_id = <span class="number">3</span></span><br><span class="line">    )</span><br><span class="line"><span class="comment">-- all查询</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> invoices</span><br><span class="line"><span class="keyword">where</span> invoice_total &gt; <span class="keyword">all</span> (</span><br><span class="line">	<span class="keyword">select</span> invoice_total</span><br><span class="line">    <span class="keyword">from</span> invoices</span><br><span class="line">    <span class="keyword">where</span> client_id = <span class="number">3</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h3 id="The-ANY-Keyword-ANY关键字"><a href="#The-ANY-Keyword-ANY关键字" class="headerlink" title="The ANY Keyword | ANY关键字"></a>The ANY Keyword | ANY关键字</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- any代表括号任何数字</span></span><br><span class="line"><span class="comment">-- any和some相同</span></span><br><span class="line"><span class="comment">-- ‘=any’可以和in转换</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> clients</span><br><span class="line"><span class="keyword">where</span> client_id = <span class="keyword">any</span> (</span><br><span class="line">	<span class="keyword">select</span> client_id</span><br><span class="line">	<span class="keyword">from</span> invoices</span><br><span class="line">	<span class="keyword">group</span> <span class="keyword">by</span> client_id</span><br><span class="line">	<span class="keyword">having</span> <span class="keyword">count</span>(*) &gt;= <span class="number">2</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h3 id="Correlated-Subqueries-相关子查询"><a href="#Correlated-Subqueries-相关子查询" class="headerlink" title="Correlated Subqueries 相关子查询"></a>Correlated Subqueries 相关子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 相关子查询：子查询中包含父查询的值</span></span><br><span class="line"><span class="comment">-- 先获得父查询的对应值，再执行子查询</span></span><br><span class="line"><span class="comment">-- 子查询更慢，占用更多存储</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> employees e</span><br><span class="line"><span class="keyword">where</span> salary &gt; (</span><br><span class="line">	<span class="keyword">select</span> vag(salary)</span><br><span class="line">    <span class="keyword">from</span> employees</span><br><span class="line">    <span class="keyword">where</span> office_id = e.office_id</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h3 id="The-EXISTS-Operator-EXISTS-运算符"><a href="#The-EXISTS-Operator-EXISTS-运算符" class="headerlink" title="The EXISTS Operator | EXISTS 运算符"></a>The EXISTS Operator | EXISTS 运算符</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 当内查询寻返回的数据量很大时，exists效率会更高，因为它不用返回外查询结果的表</span></span><br><span class="line"><span class="comment">-- 一般in语句</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> clients</span><br><span class="line"><span class="keyword">where</span> client_id <span class="keyword">in</span> (</span><br><span class="line">	<span class="keyword">select</span> <span class="keyword">distinct</span> client_id</span><br><span class="line">    <span class="keyword">from</span> invoices</span><br><span class="line">    )</span><br><span class="line"><span class="comment">-- exists语句</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> clients c</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (</span><br><span class="line">	<span class="keyword">select</span> client_id</span><br><span class="line">    <span class="keyword">from</span> invoices</span><br><span class="line">    <span class="keyword">where</span> client_id = c.client_id</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><h3 id="Subqueries-in-the-SELECT-Clause-SELECT句子中的子查询"><a href="#Subqueries-in-the-SELECT-Clause-SELECT句子中的子查询" class="headerlink" title="Subqueries in the SELECT Clause | SELECT句子中的子查询"></a>Subqueries in the SELECT Clause | SELECT句子中的子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在SELECT表达式中用select invoice_average替代上一次查询结果</span></span><br><span class="line"><span class="comment">-- 这里的查询可以为每一行都插入平均值，直接用avg(invoice_total)仅有一行结果</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	invoice_id,</span><br><span class="line">    invoice_total,</span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">avg</span>(invoice_total)</span><br><span class="line">		<span class="keyword">from</span> invoices) <span class="keyword">as</span> invoice_average,</span><br><span class="line">	invoice_total - (<span class="keyword">select</span> invoice_average) <span class="keyword">as</span> diffrence</span><br><span class="line"><span class="keyword">from</span> invoices</span><br><span class="line"><span class="comment">-- select中相关子查询</span></span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	client_id,</span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    (<span class="keyword">select</span> <span class="keyword">sum</span>(invoice_total)</span><br><span class="line">		<span class="keyword">from</span> invoices</span><br><span class="line">        <span class="keyword">where</span> client_id = c.client_id) <span class="keyword">as</span> total_sales,</span><br><span class="line">	(<span class="keyword">select</span> <span class="keyword">avg</span>(invoice_total)</span><br><span class="line">		<span class="keyword">from</span> invoices) <span class="keyword">as</span> avarag,</span><br><span class="line">	(<span class="keyword">select</span> total_sales - avarag) <span class="keyword">as</span> diffrence</span><br><span class="line"><span class="keyword">from</span> clients c</span><br></pre></td></tr></table></figure><h3 id="Subqueries-in-the-RROM-Clause-FROM中的子查询"><a href="#Subqueries-in-the-RROM-Clause-FROM中的子查询" class="headerlink" title="Subqueries in the RROM Clause | FROM中的子查询"></a>Subqueries in the RROM Clause | FROM中的子查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- from中子查询相当于一张新表，必须设置表名（as sales_summary）</span></span><br><span class="line"><span class="comment">-- 正常情况下我们将其存为视图，简化查询</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">	<span class="keyword">select</span> </span><br><span class="line">		client_id,</span><br><span class="line">		<span class="keyword">name</span>,</span><br><span class="line">		(<span class="keyword">select</span> <span class="keyword">sum</span>(invoice_total)</span><br><span class="line">			<span class="keyword">from</span> invoices</span><br><span class="line">			<span class="keyword">where</span> client_id = c.client_id) <span class="keyword">as</span> total_sales,</span><br><span class="line">		(<span class="keyword">select</span> <span class="keyword">avg</span>(invoice_total)</span><br><span class="line">			<span class="keyword">from</span> invoices) <span class="keyword">as</span> avarag,</span><br><span class="line">		(<span class="keyword">select</span> total_sales - avarag) <span class="keyword">as</span> diffrence</span><br><span class="line">	<span class="keyword">from</span> clients c</span><br><span class="line">	) <span class="keyword">as</span> sales_summary</span><br><span class="line"><span class="keyword">where</span> total_sales <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure></div><footer class="article-footer"> <a data-url="https://blog.estralletommm.top/2021/03/22/SQL%E8%AF%AD%E5%8F%A5%E6%80%BB%E7%BB%93/" data-id="cle6sor3i000udw9jeve4d5k7" class="article-share-link">Share</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL/" rel="tag">SQL</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li></ul></footer></div></article><article id="post-java_多线程编程_线程不安全集合" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"> <a href="/2021/03/15/java_%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B_%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%AE%89%E5%85%A8%E9%9B%86%E5%90%88/" class="article-date"><time datetime="2021-03-15T06:56:04.000Z" itemprop="datePublished">2021-03-15</time></a><div class="article-category"> <a class="article-category-link" href="/categories/java/">java</a></div></div><div class="article-inner"><header class="article-header"><h1 itemprop="name"> <a class="article-title" href="/2021/03/15/java_%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B_%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%AE%89%E5%85%A8%E9%9B%86%E5%90%88/">线程不安全集合</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="java多线程编程-线程不安全集合"><a href="#java多线程编程-线程不安全集合" class="headerlink" title="java多线程编程_线程不安全集合"></a><center>java多线程编程_线程不安全集合</center></h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>以前在学习List类的时候，印象中老是能听到几个学习能力超群的学生说List线程不安全，我学的也差，当时连线程的概念可能都还没有，就更别说安不安全了。最近重新学习Java的过程我才有一些深刻的体会。 属予作文以记之 ！</p><h2 id="复刻与分析"><a href="#复刻与分析" class="headerlink" title="复刻与分析"></a>复刻与分析</h2><p>线程的概念是在操作系统中接触的， 官方介绍是操作系统能够进行运算调度的最小单位，它被包含在进程之中，是进程中的实际运作单位。也就是一段程序可能有多个任务，且需要同时执行，如k歌软件会在计时的同时录音还播放伴奏。此时靠我们正常的顺序执行程序满足不了，这个时候我们可以将计时、录音、播放伴奏分别分给三个线程，每个线程执行自己给定任务。</p><p>那不安全又是什么意思？在多个线程执行时，会有同时操作一个变量的情况。如三个线程抢票，票数量只有1张，三个线程此时看到有一张票，会都令票数-1，最终票数变为-2，这种不合理情况称为线程不安全。我们希望的是票数到0就没票了，也就是三个人只有一个人抢到了票。</p><p>不安全抢票演示代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Estralle Tommm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span> 2021-03-14-11:42</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">//不安全的买票</span></span><br><span class="line"><span class="comment">//线程不安全，有负数和相同的数</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeBuyTicket</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        BuyTicket buyTicket = <span class="keyword">new</span> BuyTicket();</span><br><span class="line">        <span class="keyword">new</span> Thread(buyTicket,<span class="string">"我"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(buyTicket,<span class="string">"你"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(buyTicket,<span class="string">"黄牛"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyTicket</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ticketNum = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (flag)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                buy();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buy</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"><span class="comment">//        判断是否有票</span></span><br><span class="line">        <span class="keyword">if</span> (ticketNum &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            flag = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line"><span class="comment">//        买票</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">"拿到"</span>+ticketNum--);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><p><img src="https://wisdomclass.tech/blog/2021/0315/image-20210315101154430.png" alt="image-20210315101154430"></p><p>回归主题，线程不安全集合又是什么意思？我们看一看下面的代码（创建线程部分用到lambda表达式）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//线程不安全的集合</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeList</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">//创建list集合</span></span><br><span class="line">        List&lt;String&gt;  list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span> ; i++) &#123;</span><br><span class="line">            <span class="comment">//创建线程</span></span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                list.add(Thread.currentThread().getName());</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//延时</span></span><br><span class="line">        Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在主方法里创建一个List集合并且将循环1w次，每次创建一个线程将该线程的名字存入list列表。延时3s，这里延时的意义在于等待所有线程执行完毕再输出list集合的大小（如果不延时，直接输出list大小，此时线程往list存的过程可能还有很多未执行完，此时的list大小，并不是最终大小）。不难分析出输出应该为1w，实际结果：</p><p><img src="https://wisdomclass.tech/blog/2021/0315/image-20210315102415912.png" alt="image-20210315102415912"></p><p><strong>？？？why？</strong></p><p>我们知道，在线程在执行的过程中是异步的，也就是说在给list赋值的过程中他们同时看到有一片空的内存空间，于是多个线程都给这个空间赋值，导致先赋的值被后面的覆盖。所以1w次下来list的大小可能小于1w。这就是那些能力超群 的学生说的list线程不安全。</p><h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>解决办法也是很简单的，我们可以很明显的看到造成不安全的原因其实是多个线程抢占同一资源。所以通过让他们排队和对互斥资源加锁能够很好解决。Java中提供了<code>synchronized</code>关键字保证线程同步。它可以用来修饰方法体，表示各个线程只能互斥的访问该方法。同时我们也可以通过<code>synchronized</code>块来互斥访问某个变量。</p><p>修饰方法体例子，将不安全抢票程序对应位置添加<code>synchronized</code>关键字，将buy方法互斥访问，即可保证线程安全：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// synchronized同步方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">buy</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"><span class="comment">//        判断是否有票</span></span><br><span class="line">        <span class="keyword">if</span> (ticketNum &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">            flag = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line"><span class="comment">//        买票</span></span><br><span class="line">        System.out.println(Thread.currentThread().getName()+<span class="string">"拿到"</span>+ticketNum--);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>synchronized</code>块例子，将线程不安全集合代码创建线程处改为如下，互斥访问list集合，此时安全，输出1w：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">	<span class="keyword">synchronized</span>(list)&#123;</span><br><span class="line">    	list.add(Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).start();</span><br></pre></td></tr></table></figure><p>除了<code>synchronized</code>这种办法，Java对于集合还提供了<code>CopyOnWriteArrayList</code>线程安全集合，用该类创建list集合，不会有线程不安全的问题。代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJUC</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        CopyOnWriteArrayList&lt;String&gt; list = <span class="keyword">new</span> CopyOnWriteArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                list.add(Thread.currentThread().getName());</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出：</p><p><img src="https://wisdomclass.tech/blog/2021/0315/image-20210315105113827.png" alt="image-20210315105113827"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在多线程编程中，线程的同步和异步问题会频繁的接触，记住通过排队+锁的机制保持同步。对于线程操作集合也要考虑到线程不安全情况。加油！</p></div><footer class="article-footer"> <a data-url="https://blog.estralletommm.top/2021/03/15/java_%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B_%E7%BA%BF%E7%A8%8B%E4%B8%8D%E5%AE%89%E5%85%A8%E9%9B%86%E5%90%88/" data-id="cle6sor3x001idw9j9ff35xwh" class="article-share-link">Share</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%8C%E6%AD%A5/" rel="tag">同步</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B/" rel="tag">线程</a></li></ul></footer></div></article><article id="post-java_Lambda表达式" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"> <a href="/2021/03/10/java_Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="article-date"><time datetime="2021-03-10T06:56:04.000Z" itemprop="datePublished">2021-03-10</time></a><div class="article-category"> <a class="article-category-link" href="/categories/java/">java</a></div></div><div class="article-inner"><header class="article-header"><h1 itemprop="name"> <a class="article-title" href="/2021/03/10/java_Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/">lambda表达式</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="java-Lambda表达式"><a href="#java-Lambda表达式" class="headerlink" title="java_Lambda表达式"></a><center>java_Lambda表达式</center></h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近看代码，注意到这样一句：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Thread(()-&gt;System.out.println(<span class="string">"hello world!"</span>)).start();</span><br></pre></td></tr></table></figure><p>？？？这java代码怎么还搞ES6箭头函数那一套，今天抽时间了解和总结一下。</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Lambda表达式是java8的新特性，只保留核心逻辑使代码更加的简洁。但是使用它需要一个前提—函数式接口。任何接口，如果只包含唯一一个抽象方法，它就是一个函数式接口。对于函数式接口，我们就可以<strong>通过lambda表达式来创建该接口的对象</strong>（我们知道接口是不能通过new创建对象的，这里的创建接口对象其实是通过匿名内部类创建出一个普通类实现接口，再用到多态的概念用接口类型来接收这个普通类）。</p><h2 id="推导过程"><a href="#推导过程" class="headerlink" title="推导过程"></a>推导过程</h2><p>首先定义一个函数式接口ILike，其中只有一个抽象方法lambda。创建一个Like类实现lambda方法。最后在main方法中创建ILike接口对象并调用lambda方法。代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Estralle Tommm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span> 2021-03-03-16:51</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="comment">// 推导lambda表达式</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLambda1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ILike like = <span class="keyword">new</span> Like();</span><br><span class="line">        like.lambda(<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1. 定义一个函数式接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ILike</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lambda</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 2.实现类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Like</span> <span class="keyword">implements</span> <span class="title">ILike</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lambda</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"I like lambda"</span>+a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了简化，我们可以将实现类作为静态内部类，创建接口对象调用lambda方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLambda1</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 3.静态内部类</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Like2</span> <span class="keyword">implements</span> <span class="title">ILike</span></span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lambda</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"I like lambda2"</span>+a);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ILike like = <span class="keyword">new</span> Like2();</span><br><span class="line">        like.lambda(<span class="number">101</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1. 定义一个函数式接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ILike</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lambda</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们还可以将类作为局部内部类，使其在main方法中，达到简化的目的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLambda1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 4. 局部内部类</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Like3</span> <span class="keyword">implements</span> <span class="title">ILike</span></span>&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lambda</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"I like lambda3"</span>+a);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ILike like = <span class="keyword">new</span> Like3();</span><br><span class="line">        like.lambda(<span class="number">102</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1. 定义一个函数式接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ILike</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">lambda</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来还可以使用匿名内部类，继续达到简化的目的。借助接口创建实体，并且调用lambda方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLambda1</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 3.静态内部类</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Like2</span> <span class="keyword">implements</span> <span class="title">ILike</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 5.匿名内部类, 没有类的名称，必须借助接口或者父类</span></span><br><span class="line">        ILike like = <span class="keyword">new</span> ILike() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lambda</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"I like lambda4"</span>+a);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        like.lambda(<span class="number">103</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1. 定义一个函数式接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ILike</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lambda</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后随着JDK1.8，我们还可以用lambda表达式简化，此时ILike为函数式接口，用括号表示参数，花括号内部为方法体。因为函数式接口中只有一个抽象函数，此时lambda表达式中的具体逻辑代码都是对该抽象方法的重写：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推导lambda表达式</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestLambda1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//6. 用lambda简化</span></span><br><span class="line">        ILike like = (<span class="keyword">int</span> a)-&gt; &#123;System.out.println(<span class="string">"I like lambda5"</span>+a);&#125;;</span><br><span class="line">        like.lambda(<span class="number">104</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1. 定义一个函数式接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ILike</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lambda</span><span class="params">(<span class="keyword">int</span> a)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从最原始的方式到一步步简化最后衍生出lambda表达式。</p><h2 id="lambda简化"><a href="#lambda简化" class="headerlink" title="lambda简化"></a>lambda简化</h2><p>我们可以看到此时表达式为</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ILike like = (<span class="keyword">int</span> a)-&gt; &#123;System.out.println(<span class="string">"I like lambda5"</span>+a);&#125;;</span><br></pre></td></tr></table></figure><p>简化一：去掉参数类型；即使是多个参数类型也能去掉，但是需要保持一致，都去掉或者都加上，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ILike like = (a)-&gt; &#123;System.out.println(<span class="string">"I like lambda5"</span>+a);&#125;;</span><br></pre></td></tr></table></figure><p>简化二：去掉括号；只有当参数为一个时且去掉参数类型时可以去掉参数括号，当无参数时括号不能省去，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ILike like = a-&gt; &#123;System.out.println(<span class="string">"I like lambda5"</span>+a);&#125;;</span><br></pre></td></tr></table></figure><p>简化三：去掉花括号；当花括号内只有一行代码时可以去掉花括号，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ILike like = a-&gt; System.out.println(<span class="string">"I like lambda5"</span>+a);</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>lambda表达式其实是对代码的简化，从类-&gt;静态内部类-&gt;局部内部类-&gt;匿名内部类-&gt;lambda表达式一步步简化得来的。lambda表达式本身也可以去掉参数类型、省略括号和花括号等简化方式。最重要的一点是必须是函数式接口才能使用lambda表达式。</p><p>我们知道Runnable接口就属于函数式接口，因此lambda表达式也常用于线程的创建。</p><p>欢迎讨论指正！</p></div><footer class="article-footer"> <a data-url="https://blog.estralletommm.top/2021/03/10/java_Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" data-id="cle6sor3y001kdw9j6cgjg1zw" class="article-share-link">Share</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">lambda表达式</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3/" rel="tag">函数式接口</a></li></ul></footer></div></article><article id="post-java_抽象类构造方法问题" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"> <a href="/2021/03/03/java_%E6%8A%BD%E8%B1%A1%E7%B1%BB%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E9%97%AE%E9%A2%98/" class="article-date"><time datetime="2021-03-03T06:56:04.000Z" itemprop="datePublished">2021-03-03</time></a><div class="article-category"> <a class="article-category-link" href="/categories/java/">java</a></div></div><div class="article-inner"><header class="article-header"><h1 itemprop="name"> <a class="article-title" href="/2021/03/03/java_%E6%8A%BD%E8%B1%A1%E7%B1%BB%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E9%97%AE%E9%A2%98/">抽象类构造方法问题</a></h1></header><div class="article-entry" itemprop="articleBody"><h1 id="抽象类构造方法问题"><a href="#抽象类构造方法问题" class="headerlink" title="抽象类构造方法问题"></a><center>抽象类构造方法问题</center></h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​ 最近重新看java的时候，在抽象类和接口的章节，注意到抽象类不能用new创建对象，那这样的话抽象类当中是否有默认的构造方法？在接口中又是否有构造方法？这里记录了一下思考过程。</p><h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>​ 不难发现，构造器的作用无非是赋初始值等初始化操作，abstract类也就是抽象类一般用于被继承，实现其约束好的方法实体。假设继承关系是Object-&gt;abstract类-&gt;子类，这时候我们如果创建一个子类对象，此时会调用从Object开始的所有父亲的构造方法，才算完成初始化工作。换句话说，会先调用Object的构造方法，再调用abstract类构造方法，最后调用子类构造方法完成初始化。从这个方面考虑抽象类必须有构造函数。</p><p>​ 当在接口里面写构造放法时会提示：Interfaces cannot have constructors。接口不能有构造方法。我们知道构造方法是赋初始值初始化的，但是接口中所有变量都默认有public static final修饰，也就是常亮，因此没有构造函数。 其次接口是被其他类用关键字 implements 来实现接口定义的方法的，同时可以实现多个接口，若有构造方法，则调用顺序不好确定。最后呢接口是定义方法约束的，是一种规范，被调用时，主要关注的是里边的方法，而方法是不需要初始化的。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>接口不能有构造方法，抽象类可以有。</li><li>接口不能有方法体，抽象类可以有。</li><li>接口不能有静态方法，抽象类可以有。</li><li>接口中变量必须是public static final，抽象类中没有要求。</li></ol></div><footer class="article-footer"> <a data-url="https://blog.estralletommm.top/2021/03/03/java_%E6%8A%BD%E8%B1%A1%E7%B1%BB%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E9%97%AE%E9%A2%98/" data-id="cle6sor3z001mdw9j0bx4bk8w" class="article-share-link">Share</a><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/abstract/" rel="tag">abstract</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%8A%BD%E8%B1%A1%E7%B1%BB/" rel="tag">抽象类</a></li></ul></footer></div></article><nav id="page-nav"> <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">下一页 &amp;raquo;</a></nav></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">分类</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode%E7%AE%97%E6%B3%95%E9%A2%98/">LeetCode算法题</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Qt/">Qt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SQL/">SQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo%E5%8A%A0%E9%80%9F%E4%BC%98%E5%8C%96/">hexo加速优化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE/">hexo无法访问</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux%E5%86%85%E6%A0%B8%E5%88%86%E6%9E%90/">linux内核分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/oracle%E6%95%B0%E6%8D%AE%E5%BA%93/">oracle数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/">单点登录</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%91%86%E5%A4%B4/">呆头</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%98%93%E9%80%9A%E4%B8%AA%E6%80%A7%E5%8C%96%E5%BC%80%E5%8F%91/">易通个性化开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B5%8B%E8%AF%95/">测试</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">组成原理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95/">软件测试</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签</h3><div class="widget"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Binder/" rel="tag">Binder</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDN/" rel="tag">CDN</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag">C语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80%EF%BC%8C%E5%B7%A5%E4%BD%9C%E8%80%85%E7%BA%BF%E7%A8%8B/" rel="tag">C语言，工作者线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80%EF%BC%8C%E5%B7%A5%E4%BD%9C%E8%80%85%E7%BA%BF%E7%A8%8B%EF%BC%8C%E5%AE%8C%E6%88%90%E5%8F%98%E9%87%8F/" rel="tag">C语言，工作者线程，完成变量</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IDEA/" rel="tag">IDEA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ISE/" rel="tag">ISE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Junit/" rel="tag">Junit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/" rel="tag">LeetCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Postman/" rel="tag">Postman</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Qcreator/" rel="tag">Qcreator</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Qt/" rel="tag">Qt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL/" rel="tag">SQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/abstract/" rel="tag">abstract</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/coding/" rel="tag">coding</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eclips/" rel="tag">eclips</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kfifo/" rel="tag">kfifo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="tag">lambda表达式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/loadrunner/" rel="tag">loadrunner</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oracle/" rel="tag">oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postman/" rel="tag">postman</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssm-java/" rel="tag">ssm java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/verilog%EF%BC%8C%E6%8C%87%E4%BB%A4%EF%BC%8CComposition-principle/" rel="tag">verilog，指令，Composition-principle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%83%E7%89%9B%E4%BA%91/" rel="tag">七牛云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E6%A0%B8%E7%BA%BF%E7%A8%8B/" rel="tag">内核线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E6%A0%B8%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA/" rel="tag">内核线程创建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3/" rel="tag">函数式接口</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A0%E9%80%9F%E4%BC%98%E5%8C%96/" rel="tag">加速优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" rel="tag">单点登录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8C%E6%AD%A5/" rel="tag">同步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%91%86%E5%A4%B4/" rel="tag">呆头</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E7%AE%97%E6%B3%95/" rel="tag">图像处理算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%BE%E5%BA%8A/" rel="tag">图床</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E5%AE%A2%E6%88%B7%E7%AB%AF/" rel="tag">多客户端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8A%BD%E8%B1%A1%E7%B1%BB/" rel="tag">抽象类</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95/" rel="tag">接口测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E6%B3%B5/" rel="tag">数据泵</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84%E7%AE%97%E6%B3%95/" rel="tag">最短路径算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%BB%E5%8A%A8%E5%86%85%E6%A0%B8/" rel="tag">移动内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%80%E5%8D%95%E9%9A%BE%E5%BA%A6/" rel="tag">简单难度</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B/" rel="tag">线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" rel="tag">组成原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%85%BE%E8%AE%AF%E5%BC%80%E5%8F%91%E8%80%85%E5%B9%B3%E5%8F%B0/" rel="tag">腾讯开发者平台</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95/" rel="tag">软件测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" rel="tag">进程间通信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E5%AE%9E%E7%8E%B0/" rel="tag">进程间通信实现</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%98%9F%E5%88%97/" rel="tag">队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%AD%98%E5%82%A8/" rel="tag">静态资源存储</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签云</h3><div class="widget tagcloud"> <a href="/tags/Binder/" style="font-size:10px">Binder</a> <a href="/tags/C/" style="font-size:10px">C++</a> <a href="/tags/CDN/" style="font-size:10px">CDN</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size:16.67px">C语言</a> <a href="/tags/C%E8%AF%AD%E8%A8%80%EF%BC%8C%E5%B7%A5%E4%BD%9C%E8%80%85%E7%BA%BF%E7%A8%8B/" style="font-size:10px">C语言，工作者线程</a> <a href="/tags/C%E8%AF%AD%E8%A8%80%EF%BC%8C%E5%B7%A5%E4%BD%9C%E8%80%85%E7%BA%BF%E7%A8%8B%EF%BC%8C%E5%AE%8C%E6%88%90%E5%8F%98%E9%87%8F/" style="font-size:10px">C语言，工作者线程，完成变量</a> <a href="/tags/IDEA/" style="font-size:10px">IDEA</a> <a href="/tags/ISE/" style="font-size:10px">ISE</a> <a href="/tags/Junit/" style="font-size:13.33px">Junit</a> <a href="/tags/LeetCode/" style="font-size:10px">LeetCode</a> <a href="/tags/Linux/" style="font-size:10px">Linux</a> <a href="/tags/MySQL/" style="font-size:10px">MySQL</a> <a href="/tags/Postman/" style="font-size:10px">Postman</a> <a href="/tags/Qcreator/" style="font-size:10px">Qcreator</a> <a href="/tags/Qt/" style="font-size:10px">Qt</a> <a href="/tags/SQL/" style="font-size:10px">SQL</a> <a href="/tags/abstract/" style="font-size:10px">abstract</a> <a href="/tags/coding/" style="font-size:10px">coding</a> <a href="/tags/eclips/" style="font-size:10px">eclips</a> <a href="/tags/github/" style="font-size:13.33px">github</a> <a href="/tags/hexo/" style="font-size:13.33px">hexo</a> <a href="/tags/java/" style="font-size:16.67px">java</a> <a href="/tags/kfifo/" style="font-size:10px">kfifo</a> <a href="/tags/lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size:10px">lambda表达式</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size:20px">linux内核</a> <a href="/tags/loadrunner/" style="font-size:10px">loadrunner</a> <a href="/tags/oracle/" style="font-size:10px">oracle</a> <a href="/tags/postman/" style="font-size:13.33px">postman</a> <a href="/tags/ssm-java/" style="font-size:10px">ssm java</a> <a href="/tags/verilog%EF%BC%8C%E6%8C%87%E4%BB%A4%EF%BC%8CComposition-principle/" style="font-size:10px">verilog，指令，Composition-principle</a> <a href="/tags/%E4%B8%83%E7%89%9B%E4%BA%91/" style="font-size:13.33px">七牛云</a> <a href="/tags/%E5%86%85%E6%A0%B8%E7%BA%BF%E7%A8%8B/" style="font-size:13.33px">内核线程</a> <a href="/tags/%E5%86%85%E6%A0%B8%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA/" style="font-size:10px">内核线程创建</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3/" style="font-size:10px">函数式接口</a> <a href="/tags/%E5%8A%A0%E9%80%9F%E4%BC%98%E5%8C%96/" style="font-size:16.67px">加速优化</a> <a href="/tags/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/" style="font-size:16.67px">单点登录</a> <a href="/tags/%E5%90%8C%E6%AD%A5/" style="font-size:10px">同步</a> <a href="/tags/%E5%91%86%E5%A4%B4/" style="font-size:13.33px">呆头</a> <a href="/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86%E7%AE%97%E6%B3%95/" style="font-size:10px">图像处理算法</a> <a href="/tags/%E5%9B%BE%E5%BA%8A/" style="font-size:10px">图床</a> <a href="/tags/%E5%A4%9A%E5%AE%A2%E6%88%B7%E7%AB%AF/" style="font-size:10px">多客户端</a> <a href="/tags/%E6%8A%BD%E8%B1%A1%E7%B1%BB/" style="font-size:10px">抽象类</a> <a href="/tags/%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95/" style="font-size:10px">接口测试</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size:13.33px">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E6%B3%B5/" style="font-size:10px">数据泵</a> <a href="/tags/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84%E7%AE%97%E6%B3%95/" style="font-size:10px">最短路径算法</a> <a href="/tags/%E7%A7%BB%E5%8A%A8%E5%86%85%E6%A0%B8/" style="font-size:10px">移动内核</a> <a href="/tags/%E7%AE%80%E5%8D%95%E9%9A%BE%E5%BA%A6/" style="font-size:10px">简单难度</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:10px">算法</a> <a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size:10px">线程</a> <a href="/tags/%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/" style="font-size:10px">组成原理</a> <a href="/tags/%E8%85%BE%E8%AE%AF%E5%BC%80%E5%8F%91%E8%80%85%E5%B9%B3%E5%8F%B0/" style="font-size:13.33px">腾讯开发者平台</a> <a href="/tags/%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95/" style="font-size:13.33px">软件测试</a> <a href="/tags/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/" style="font-size:10px">进程间通信</a> <a href="/tags/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E5%AE%9E%E7%8E%B0/" style="font-size:10px">进程间通信实现</a> <a href="/tags/%E9%98%9F%E5%88%97/" style="font-size:10px">队列</a> <a href="/tags/%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%AD%98%E5%82%A8/" style="font-size:10px">静态资源存储</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size:10px">面试</a></div></div><div class="widget-wrap"><h3 class="widget-title">归档</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2000/02/">二月 2000</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1999/11/">十一月 1999</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">最新文章</h3><div class="widget"><ul><li> <a href="/2021/11/04/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%B8%89%E2%80%94%E2%80%94CAS%20Clietn%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">单点登录三——CAS Client源码分析</a></li><li> <a href="/2021/10/27/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%BA%8C%E2%80%94%E2%80%94CAS/">单点登录二——CAS</a></li><li> <a href="/2021/10/26/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E4%B8%80%E2%80%94%E2%80%94%E5%8E%9F%E7%90%86/">单点登录一——原理</a></li><li> <a href="/2021/09/06/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E6%95%B0%E6%8D%AE%E6%B3%B5%E8%BF%98%E5%8E%9F/">oracle数据库还原</a></li><li> <a href="/2021/06/23/%E4%B8%AA%E6%80%A7%E5%8C%96%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93_Tom/">易通个性化开发总结</a></li></ul></div></div></aside></div><footer id="footer"><div class="outer"><div id="footer-info" class="inner"> &copy; 2023 Estralle Tommm<br> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></div></div></footer></div><nav id="mobile-nav"> <a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a></nav><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script src="/js/script.js"></script></div><script>"use strict";"serviceWorker"in navigator&&navigator.serviceWorker.register("service-worker.js").then(function(r){r.onupdatefound=function(){var e=r.installing;e.onstatechange=function(){switch(e.state){case"installed":navigator.serviceWorker.controller?console.log("New or updated content is available."):console.log("Content is now available offline!");break;case"redundant":console.error("The installing service worker became redundant.")}}}}).catch(function(e){console.error("Error during service worker registration:",e)})</script></body></html>